<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Ch·∫•m ƒëi·ªÉm 5S - B·ªánh vi·ªán Nhi ƒë·ªìng TP C·∫ßn Th∆°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        select.form-control {
            cursor: pointer;
        }

        .login-box {
            max-width: 400px;
            margin: 50px auto;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 24px;
            color: var(--gray-800);
        }

        /* Login box responsive cho mobile */
        @media (max-width: 480px) {
            .login-box {
                margin: 20px auto;
                max-width: 100%;
            }

            .login-box h2 {
                font-size: 1.4rem;
            }

            .login-box .form-control {
                padding: 16px 14px;
                font-size: 16px;
            }

            .login-box .btn {
                padding: 16px;
                font-size: 16px;
                min-height: 50px;
            }
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        tr:hover {
            background: var(--gray-50);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-user {
            background: #dbeafe;
            color: #1e40af;
        }

        .score-table {
            font-size: 0.9rem;
        }

        .score-table th {
            position: sticky;
            top: 0;
            background: var(--primary);
            color: white;
        }

        .score-table .s-group {
            background: #eff6ff;
            font-weight: 600;
            color: var(--primary);
        }

        .score-radio {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .score-radio label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .score-radio input {
            display: none;
        }

        .score-radio input:checked+span {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .score-radio span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .reason-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .stats-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            border-radius: 12px;
        }

        .stats-card h3 {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .stats-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .flex {
            display: flex;
        }

        .flex-between {
            justify-content: space-between;
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .score-radio label {
                width: 30px;
                height: 30px;
            }
        }

        /* ===== MOBILE RESPONSIVE CHO TAB CH·∫§M ƒêI·ªÇM ===== */
        @media (max-width: 768px) {
            /* Container padding cho mobile */
            .container {
                padding: 10px;
            }

            .card {
                padding: 16px;
                border-radius: 12px;
            }

            /* Grid form 1 c·ªôt tr√™n mobile */
            .grid-2 {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Form controls l·ªõn h∆°n cho touch */
            .form-control {
                padding: 14px 12px;
                font-size: 16px; /* NgƒÉn iOS zoom khi focus */
                border-radius: 10px;
                -webkit-appearance: none;
                appearance: none;
            }

            select.form-control {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23374151' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                padding-right: 36px;
            }

            /* Input file cho mobile */
            #scoreImageFile {
                font-size: 14px;
            }
        }

        /* ===== B·∫¢NG CH·∫§M ƒêI·ªÇM D·∫†NG CARD TR√äN MOBILE ===== */
        @media (max-width: 600px) {
            /* ·∫®n header c·ªßa b·∫£ng */
            .score-table thead {
                display: none;
            }

            .score-table,
            .score-table tbody,
            .score-table tr {
                display: block;
                width: 100%;
            }

            /* M·ªói h√†ng th√†nh 1 card */
            .score-table tr {
                background: white;
                border: 1px solid var(--gray-200);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            .score-table tr:hover {
                background: white;
            }

            /* Group header */
            .score-table tr.s-group {
                background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
                color: white;
                font-size: 1rem;
                padding: 12px 16px;
                margin-top: 16px;
                margin-bottom: 8px;
            }

            .score-table tr.s-group td {
                padding: 0;
                border: none;
            }

            /* C√°c cell th√†nh block */
            .score-table td {
                display: block;
                width: 100%;
                text-align: left;
                padding: 8px 0;
                border: none;
                border-bottom: 1px solid var(--gray-100);
            }

            .score-table td:last-child {
                border-bottom: none;
            }

            /* STT v√† ti√™u ch√≠ */
            .score-table td:first-child {
                font-weight: 700;
                color: var(--primary);
                font-size: 0.85rem;
            }

            .score-table td:nth-child(2) {
                font-size: 0.95rem;
                line-height: 1.5;
                padding-bottom: 12px;
            }

            /* Radio buttons l·ªõn h∆°n, d·ªÖ b·∫•m */
            .score-radio {
                justify-content: flex-start;
                gap: 10px;
                padding: 8px 0;
            }

            .score-radio label {
                width: 44px;
                height: 44px;
                font-size: 16px;
                border-width: 2px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .score-radio span {
                font-weight: 600;
            }

            /* Input l√Ω do */
            .reason-input {
                padding: 12px;
                font-size: 16px;
                border-radius: 8px;
                margin-top: 4px;
            }

            /* N√∫t h∆∞·ªõng d·∫´n */
            .btn-guide {
                padding: 6px 12px;
                font-size: 13px;
            }

            /* Score result responsive */
            .score-result {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px;
            }

            .score-result-item {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            }

            .score-result-item:last-of-type {
                border-bottom: none;
            }

            .score-value {
                font-size: 20px;
            }

            /* N√∫t l∆∞u k·∫øt qu·∫£ */
            .btn-success {
                width: 100%;
                padding: 16px;
                font-size: 16px;
                border-radius: 12px;
            }

            /* Image preview */
            #imagePreview {
                flex-direction: column;
                align-items: center;
            }

            #imagePreview img {
                max-width: 100%;
                margin-bottom: 10px;
            }

            #imagePreview .btn-danger {
                margin-left: 0;
                width: 100%;
            }
        }

        /* ===== TOUCH OPTIMIZATIONS CHO iOS & ANDROID ===== */
        @media (hover: none) and (pointer: coarse) {
            /* T·∫Øt hi·ªáu ·ª©ng hover tr√™n touch devices */
            .nav-btn:hover,
            .btn:hover,
            tr:hover {
                transform: none;
            }

            /* TƒÉng v√πng ch·∫°m */
            .nav-btn {
                min-height: 44px;
                padding: 12px 20px;
            }

            .btn {
                min-height: 44px;
            }

            /* Radio button touch area */
            .score-radio label {
                position: relative;
            }

            .score-radio label::before {
                content: '';
                position: absolute;
                top: -8px;
                left: -8px;
                right: -8px;
                bottom: -8px;
            }

            /* Smooth scrolling */
            .score-table {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ===== LANDSCAPE MODE TR√äN MOBILE ===== */
        @media (max-width: 900px) and (orientation: landscape) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }

            .score-table tr {
                display: flex;
                flex-wrap: wrap;
                padding: 12px;
            }

            .score-table td:first-child {
                width: 50px;
            }

            .score-table td:nth-child(2) {
                flex: 1;
                min-width: 200px;
            }

            .score-table td:nth-child(3),
            .score-table td:nth-child(4) {
                width: 50%;
                padding-top: 12px;
            }
        }

        /* ===== SAFE AREA CHO iPHONE X TR·ªû L√äN ===== */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }

        /* Guide button */
        .btn-guide {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .btn-guide:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        /* Guide modal */
        .guide-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .guide-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .guide-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 16px 16px 0 0;
        }

        .guide-modal-header h3 {
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .guide-modal-header button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .guide-modal-header button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .guide-modal-body {
            padding: 24px;
        }

        /* ===== GUIDE MODAL RESPONSIVE ===== */
        @media (max-width: 600px) {
            .guide-modal-overlay {
                padding: 10px;
                align-items: flex-end;
            }

            .guide-modal {
                max-height: 85vh;
                border-radius: 16px 16px 0 0;
            }

            .guide-modal-header {
                padding: 16px;
            }

            .guide-modal-header h3 {
                font-size: 1rem;
            }

            .guide-modal-body {
                padding: 16px;
            }

            .guide-level {
                padding: 10px;
                font-size: 13px;
            }

            .level-score {
                min-width: 28px;
                height: 28px;
                font-size: 14px;
            }
        }

        .guide-criteria-text {
            background: var(--gray-100);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .guide-section {
            margin-bottom: 20px;
        }

        .guide-section h4 {
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .guide-section p {
            color: var(--gray-600);
            line-height: 1.6;
        }

        .guide-levels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .guide-level {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 14px;
        }

        .level-score {
            background: var(--primary);
            color: white;
            min-width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        /* Score result summary */
        .score-result {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .score-result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .score-label {
            font-size: 12px;
            color: var(--gray-600);
            text-transform: uppercase;
        }

        .score-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .score-classification {
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .score-result-desc {
            width: 100%;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--gray-600);
            font-style: italic;
        }

        .success-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
            text-align: center;
            font-weight: 500;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üè• B·ªánh vi·ªán Nhi ƒë·ªìng Th√†nh ph·ªë C·∫ßn Th∆°</h1>
        <p>Ph√≤ng: Qu·∫£n l√Ω Ch·∫•t l∆∞·ª£ng | T√°c gi·∫£: BS. Ki·ªÅu Vi·ªát Ti·∫øn H∆∞ng</p>
        <p id="userInfo" class="hidden" style="margin-top:10px;"></p>
    </div>

    <div class="container">
        <!-- Login -->
        <div id="loginSection">
            <div class="card login-box">
                <h2>üîê ƒêƒÉng nh·∫≠p</h2>
                <div id="loginAlert"></div>
                <form id="loginForm" onsubmit="handleLoginSubmit(event)">
                    <div class="form-group">
                        <label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" id="loginUser" class="form-control" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                            autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false"
                            inputmode="text" enterkeyhint="next">
                    </div>
                    <div class="form-group">
                        <label for="loginPass">M·∫≠t kh·∫©u</label>
                        <input type="password" id="loginPass" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                            autocomplete="current-password" enterkeyhint="go">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">ƒêƒÉng nh·∫≠p</button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <nav class="nav">
                <button class="nav-btn active" onclick="showTab('home')">üè† Trang ch·ªß</button>
                <button class="nav-btn" onclick="showTab('score')">üìù Ch·∫•m ƒëi·ªÉm</button>
                <button class="nav-btn" onclick="showTab('report')">üìä B√°o c√°o</button>
                <button class="nav-btn admin-only hidden" onclick="showTab('zones')">üìç Qu·∫£n l√Ω khu v·ª±c</button>
                <button class="nav-btn admin-only hidden" onclick="showTab('users')">üë• Qu·∫£n l√Ω t√†i kho·∫£n</button>
                <button class="nav-btn" onclick="logout()" style="background:#ef4444;">üö™ ƒêƒÉng xu·∫•t</button>
            </nav>

            <!-- Home Tab -->
            <div id="homeTab" class="tab-content active">
                <div class="card">
                    <h2 style="margin-bottom:20px;">üìä Th·ªëng k√™ t·ªïng quan</h2>
                    <div class="grid grid-3">
                        <div class="stats-card">
                            <h3 id="statDepts">0</h3>
                            <p>Khoa/Ph√≤ng</p>
                        </div>
                        <div class="stats-card" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);">
                            <h3 id="statZones">0</h3>
                            <p>Khu v·ª±c</p>
                        </div>
                        <div class="stats-card" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);">
                            <h3 id="statScores">0</h3>
                            <p>L∆∞·ª£t ch·∫•m ƒëi·ªÉm</p>
                        </div>
                    </div>
                </div>

                <!-- B·ªô l·ªçc khoa ph√≤ng cho bi·ªÉu ƒë·ªì -->
                <div class="card">
                    <h2 style="margin-bottom:20px;">üîç L·ªçc theo Khoa/Ph√≤ng</h2>
                    <div class="form-group">
                        <select id="chartDeptFilter" class="form-control" onchange="filterDashboard()">
                            <option value="">-- T·∫•t c·∫£ khoa/ph√≤ng --</option>
                        </select>
                    </div>
                </div>

                <!-- Bi·ªÉu ƒë·ªì ƒëi·ªÉm theo th√°ng -->
                <div class="card">
                    <h2 style="margin-bottom:20px;">üìà Bi·ªÉu ƒë·ªì ƒëi·ªÉm trung b√¨nh theo th√°ng</h2>
                    <div style="position:relative;height:300px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <!-- Th·ªëng k√™ theo khoa ph√≤ng -->
                <div class="card">
                    <h2 style="margin-bottom:20px;">üè• Th·ªëng k√™ theo Khoa/Ph√≤ng</h2>
                    <div id="deptStatsContainer">
                        <p class="text-center">ƒêang t·∫£i...</p>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom:20px;">üìã Ch·∫•m ƒëi·ªÉm g·∫ßn ƒë√¢y</h2>
                    <div id="recentScores">
                        <p class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                    </div>
                </div>
            </div>

            <!-- Score Tab -->
            <div id="scoreTab" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom:20px;">üìù Ch·∫•m ƒëi·ªÉm 5S</h2>
                    <div id="scoreAlert"></div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Khoa/Ph√≤ng</label>
                            <select id="scoreDept" class="form-control" onchange="loadZones()">
                                <option value="">-- Ch·ªçn khoa/ph√≤ng --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Khu v·ª±c ƒë·ªãnh danh</label>
                            <select id="scoreZone" class="form-control" onchange="loadItems()">
                                <option value="">-- Ch·ªçn khu v·ª±c --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ƒê·∫°i di·ªán ƒë·ªãnh l∆∞·ª£ng</label>
                            <select id="scoreItem" class="form-control">
                                <option value="">-- Ch·ªçn ƒë·∫°i di·ªán --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Th√°ng/NƒÉm</label>
                            <input type="month" id="scoreMonth" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Ng∆∞·ªùi ƒë√°nh gi√°</label>
                            <input type="text" id="scoreEvaluator" class="form-control"
                                placeholder="H·ªç t√™n ng∆∞·ªùi ƒë√°nh gi√°">
                        </div>
                        <div class="form-group">
                            <label>ƒê·∫°i di·ªán n∆°i ƒë√°nh gi√°</label>
                            <input type="text" id="scoreRepresentative" class="form-control"
                                placeholder="H·ªç t√™n ƒë·∫°i di·ªán">
                        </div>
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label>üì∑ H√¨nh ·∫£nh minh ch·ª©ng</label>
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                                <input type="file" id="scoreImageFile" accept="image/*" class="form-control"
                                    style="flex:1;min-width:200px;" onchange="previewImage(this)">
                                <button type="button" class="btn btn-primary btn-sm"
                                    onclick="document.getElementById('scoreImageFile').click()">üì∑ Ch·ªçn ·∫£nh</button>
                            </div>
                            <div id="imagePreview" style="margin-top:10px;display:none;">
                                <img id="previewImg"
                                    style="max-width:200px;max-height:150px;border-radius:8px;border:2px solid var(--gray-200);">
                                <button type="button" class="btn btn-danger btn-sm" style="margin-left:10px;"
                                    onclick="clearImage()">üóëÔ∏è X√≥a</button>
                            </div>
                            <input type="hidden" id="scoreImageUrl">
                        </div>
                    </div>
                    <div style="overflow-x:auto;margin-top:20px;">
                        <table class="score-table" id="criteriaTable"></table>
                    </div>
                    <div class="text-center mt-20">
                        <button class="btn btn-success" onclick="submitScore()">üíæ L∆∞u k·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm</button>
                        <div id="submitSuccessMsg" class="success-message">‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm th√†nh c√¥ng!</div>
                    </div>
                </div>
            </div>

            <!-- Report Tab -->
            <div id="reportTab" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom:20px;">üìä B√°o c√°o & Xu·∫•t d·ªØ li·ªáu</h2>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Khoa/Ph√≤ng</label>
                            <select id="reportDept" class="form-control">
                                <option value="">-- T·∫•t c·∫£ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>T·ª´ th√°ng</label>
                            <input type="month" id="reportFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>ƒê·∫øn th√°ng</label>
                            <input type="month" id="reportTo" class="form-control">
                        </div>
                        <div class="form-group" style="display:flex;align-items:flex-end;">
                            <button class="btn btn-primary" onclick="loadReport()">üîç Xem b√°o c√°o</button>
                            <button class="btn btn-success" style="margin-left:10px;" onclick="exportExcel()">üì• Xu·∫•t
                                Excel</button>
                        </div>
                    </div>
                    <div id="reportResult" class="mt-20"></div>
                </div>
            </div>

            <!-- Zones Tab -->
            <div id="zonesTab" class="tab-content">
                <div class="card">
                    <div class="flex flex-between mb-20">
                        <h2>üìç Qu·∫£n l√Ω Khu v·ª±c</h2>
                        <button class="btn btn-primary" onclick="showAddDeptModal()">‚ûï Th√™m Khoa/Ph√≤ng</button>
                    </div>
                    <div id="zonesList"></div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="card">
                    <div class="flex flex-between mb-20">
                        <h2>üë• Qu·∫£n l√Ω T√†i kho·∫£n</h2>
                        <button class="btn btn-primary" onclick="showAddUserModal()">‚ûï Th√™m t√†i kho·∫£n</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                <th>H·ªç t√™n</th>
                                <th>Khoa/Ph√≤ng</th>
                                <th>Quy·ªÅn</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="usersList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m t√†i kho·∫£n m·ªõi</h3><button class="modal-close"
                    onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="form-group"><label>T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="newUsername"
                    class="form-control"></div>
            <div class="form-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="newPassword" class="form-control">
            </div>
            <div class="form-group"><label>H·ªç t√™n</label><input type="text" id="newFullname" class="form-control"></div>
            <div class="form-group"><label>Khoa/Ph√≤ng</label><select id="newDept" class="form-control"></select></div>
            <div class="form-group"><label>Quy·ªÅn</label><select id="newRole" class="form-control">
                    <option value="user">Ng∆∞·ªùi d√πng</option>
                    <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                </select></div>
            <button class="btn btn-success" style="width:100%" onclick="addUser()">T·∫°o t√†i kho·∫£n</button>
        </div>
    </div>

    <div id="addDeptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m Khoa/Ph√≤ng</h3><button class="modal-close"
                    onclick="closeModal('addDeptModal')">&times;</button>
            </div>
            <div class="form-group"><label>T√™n Khoa/Ph√≤ng</label><input type="text" id="newDeptName"
                    class="form-control"></div>
            <button class="btn btn-success" style="width:100%" onclick="addDepartment()">Th√™m</button>
        </div>
    </div>

    <div id="addZoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m Khu v·ª±c</h3><button class="modal-close" onclick="closeModal('addZoneModal')">&times;</button>
            </div>
            <input type="hidden" id="zoneDeptId">
            <div class="form-group"><label>T√™n khu v·ª±c ƒë·ªãnh danh</label><input type="text" id="newZoneName"
                    class="form-control"></div>
            <div class="form-group"><label>ƒê·∫°i di·ªán ƒë·ªãnh l∆∞·ª£ng (m·ªói d√≤ng 1 ƒë·∫°i di·ªán)</label><textarea id="newZoneItems"
                    class="form-control" rows="4"></textarea></div>
            <button class="btn btn-success" style="width:100%" onclick="addZone()">Th√™m khu v·ª±c</button>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDummyKeyForApp5S",
            authDomain: "app-5s-b09ab.firebaseapp.com",
            databaseURL: "https://app-5s-b09ab-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "app-5s-b09ab",
            storageBucket: "app-5s-b09ab.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:app5s"
        };

        let db, currentUser = null;
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();

        // Cloudinary Config - Free tier (25GB)
        const CLOUDINARY_CONFIG = {
            cloudName: 'dvuo6snng',
            uploadPreset: '5S_upload'
        };

        // Image upload functions
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage() {
            document.getElementById('scoreImageFile').value = '';
            document.getElementById('scoreImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            formData.append('folder', '5S_BenhVienNhiDong');

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                }
                throw new Error(data.error?.message || 'Upload failed');
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                alert('L·ªói upload ·∫£nh: ' + error.message);
                return null;
            }
        }

        // 5S Criteria Data
        const CRITERIA_5S = [
            {
                group: "S√ÄNG L·ªåC", items: [
                    { id: 1, text: "Kh√¥ng c√≥ v·∫≠t d·ª•ng kh√¥ng li√™n quan t·∫°i n∆°i ƒë√°nh gi√°" },
                    { id: 2, text: "Nh·ªØng t√†i li·ªáu, v·∫≠t d·ª•ng kh√¥ng li√™n quan c√≥ th·ªÉ nh·∫≠n bi·∫øt ngay" },
                    { id: 3, text: "Kh√¥ng c√≥ s·ªë l∆∞·ª£ng th·ª´a c·ªßa t·∫•t c·∫£ c√°c v·∫≠t d·ª•ng c·∫ßn s·ª≠ d·ª•ng" },
                    { id: 4, text: "C√≥ QUY T·∫ÆC/H∆Ø·ªöNG D·∫™N S√ÄNG L·ªåC v·∫≠t d·ª•ng ƒë·ªãnh k·ª≥" }
                ]
            },
            {
                group: "S·∫ÆP X·∫æP", items: [
                    { id: 5, text: "VƒÉn ph√≤ng ph·∫©m, c√¥ng c·ª• lao ƒë·ªông,... ƒë∆∞·ª£c s·∫Øp x·∫øp ngƒÉn n·∫Øp, khoa h·ªçc" },
                    { id: 6, text: "M·ªçi th·ª© ƒë∆∞·ª£c c·∫•t, gi·ªØ t·∫°i m·ªôt n∆°i C·ªê ƒê·ªäNH" },
                    { id: 7, text: "N∆°i c·∫•t gi·ªØ ƒë∆∞·ª£c thi·∫øt k·∫ø d·ªÖ d√†ng v√† thu·∫≠n ti·ªán khi s·ª≠ d·ª•ng" },
                    { id: 8, text: "T·ªß nhi·ªÅu ngƒÉn v√† c√°c thi·∫øt b·ªã c√≥ GHI NH√ÉN R√ï R√ÄNG" },
                    { id: 9, text: "C√°c v·ªã tr√≠ ch·ªâ ƒë·ªãnh ƒë√£ ƒë∆∞·ª£c ƒê√ÅNH D·∫§U/K·∫∫ L√äN ƒë·ªÉ d·ªÖ nh√¨n th·∫•y" }
                ]
            },
            {
                group: "S·∫†CH S·∫º", items: [
                    { id: 10, text: "V√πng l√†m vi·ªác, c√°c v·∫≠t d·ª•ng ƒë·ªÅu s·∫°ch s·∫Ω, kh√¥ng b·ª•i b·∫©n" },
                    { id: 11, text: "C·ª≠a s·ªï, b·∫≠u c·ª≠a s·ªï, n·ªÅn nh√†,... ƒë·ªÅu s·∫°ch s·∫Ω" },
                    { id: 12, text: "C√≥ n∆°i l∆∞u tr·ªØ c√°c v·∫≠t d·ª•ng √≠t/kh√¥ng s·ª≠ d·ª•ng, s·∫°ch s·∫Ω, c√≥ d√°n nh√£n" },
                    { id: 13, text: "V·ªá sinh k√®m ki·ªÉm tra hi·ªán tr·∫°ng c√°c v·∫≠t d·ª•ng" }
                ]
            },
            {
                group: "SƒÇN S√ìC", items: [
                    { id: 14, text: "Kh√¥ng ƒë·ªÉ c√°c v·∫≠t d·ª•ng b·ª´a b√£i" },
                    { id: 15, text: "Lu√¥n c·∫£i ti·∫øn v√† s·∫Øp x·∫øp ngƒÉn n·∫Øp (C√ì H√åNH ·∫¢NH TR∆Ø·ªöC SAU)" },
                    { id: 16, text: "C√≥ L·ªäCH TR·ª∞C 5S t·∫°i khu v·ª±c ch·∫•m ƒëi·ªÉm" }
                ]
            },
            {
                group: "S·∫¥N S√ÄNG", items: [
                    { id: 17, text: "C√≥ ph·ªï bi·∫øn/chia s·∫ª ph∆∞∆°ng ph√°p 5S cho t·∫•t c·∫£ nh√¢n vi√™n" },
                    { id: 18, text: "C√≥ ƒë√°nh gi√° ƒë·ªãnh k·ª≥ (B·∫¢NG KI·ªÇM 5S M·ªñI TH√ÅNG)" },
                    { id: 19, text: "T·∫•t c·∫£ v·∫≠t d·ª•ng ƒë·ªÅu trong t√¨nh tr·∫°ng s·∫µn s√†ng" },
                    { id: 20, text: "C√≥ ƒë√°nh gi√°, ph√¢n t√≠ch nguy√™n nh√¢n m·ªói th√°ng" }
                ]
            }
        ];

        // H∆∞·ªõng d·∫´n ch·∫•m ƒëi·ªÉm chi ti·∫øt cho t·ª´ng ti√™u ch√≠
        const CRITERIA_GUIDES = {
            1: {
                guide: "Kh√¥ng c√≥ v·∫≠t d·ª•ng kh√¥ng li√™n quan ƒë·∫øn c√¥ng vi·ªác t·∫°i n∆°i ƒë√°nh gi√° (vd: c·ªëc ri√™ng, t√∫i x√°ch c√° nh√¢n, n√≥n,n∆∞·ªõc gi·∫£i kh√°t, b√°nh tr√°i, th·ª©c ƒÉn, ƒë·ªì trang ƒëi·ªÉm... tr√™n b√†n l√†m vi·ªác)",
                suggestion: "‚úÖ Ki·ªÉm tra nhanh xung quanh khu v·ª±c: c√≥ ƒë·ªì c√° nh√¢n n√†o kh√¥ng thu·ªôc c√¥ng vi·ªác?\n‚úÖ C√°c v·∫≠t d·ª•ng ph·∫£i r√µ r√†ng li√™n quan ƒë·∫øn chuy√™n m√¥n c·ªßa khoa/ph√≤ng",
                levels: {
                    1: "‚â•10 v·∫≠t d·ª•ng kh√¥ng li√™n quan c√¥ng vi·ªác",
                    2: "5‚Äì9 v·∫≠t d·ª•ng kh√¥ng li√™n quan",
                    3: "3‚Äì4 v·∫≠t d·ª•ng kh√¥ng li√™n quan",
                    4: "1‚Äì2 v·∫≠t d·ª•ng kh√¥ng li√™n quan",
                    5: "Kh√¥ng c√≥ b·∫•t k·ª≥ v·∫≠t d·ª•ng n√†o kh√¥ng li√™n quan"
                }
            },
            2: {
                guide: "V·∫≠t d·ª•ng, t√†i li·ªáu kh√¥ng li√™n quan kh√¥ng ƒë∆∞·ª£c gi·∫•u trong ngƒÉn k√©o, t·ªß,... c√≥ th·ªÉ nh·∫≠n bi·∫øt ngay",
                suggestion: "‚úÖ M·ªü ki·ªÉm tra ng·∫´u nhi√™n 2‚Äì3 ngƒÉn k√©o, t·ªß, h·ªôc b√†n\n‚úÖ C√≥ ƒë·ªì c√° nh√¢n gi·∫•u b√™n trong kh√¥ng?",
                levels: {
                    1: "C√≥ nhi·ªÅu v·∫≠t kh√¥ng li√™n quan gi·∫•u trong c√°c ngƒÉn k√©o, t·ªß",
                    2: "M·ªôt s·ªë v·∫≠t kh√¥ng li√™n quan gi·∫•u k√≠n",
                    3: "2‚Äì3 v·∫≠t c√° nh√¢n c√≤n ƒë·ªÉ l·∫´n",
                    4: "1 v·∫≠t c√° nh√¢n c√≤n s√≥t",
                    5: "Kh√¥ng c√≥ v·∫≠t d·ª•ng c√° nh√¢n gi·∫•u trong ngƒÉn, t·ªß"
                }
            },
            3: {
                guide: "Kh√¥ng c√≥ s·ªë l∆∞·ª£ng th·ª´a c·ªßa t·∫•t c·∫£ c√°c v·∫≠t d·ª•ng ƒë∆∞·ª£c s·ª≠ d·ª•ng",
                suggestion: "‚úÖ S·ªë l∆∞·ª£ng v·∫≠t d·ª•ng ph·∫£i ph√π h·ª£p nhu c·∫ßu th·ª±c t·∫ø (kh√¥ng qu√° nhi·ªÅu, kh√¥ng thi·∫øu)\n‚úÖ C√≥ quy ƒë·ªãnh s·ªë l∆∞·ª£ng t·ªìn tr·ªØ h·ª£p l√Ω",
                levels: {
                    1: "R·∫•t nhi·ªÅu v·∫≠t d·ª•ng th·ª´a, kh√¥ng c·∫ßn thi·∫øt",
                    2: "Nhi·ªÅu v·∫≠t d·ª•ng th·ª´a ho·∫∑c tr√πng l·∫∑p",
                    3: "M·ªôt s·ªë v·∫≠t d·ª•ng th·ª´a",
                    4: "√çt v·∫≠t d·ª•ng th·ª´a, ƒë√£ ki·ªÉm so√°t t·ªët",
                    5: "S·ªë l∆∞·ª£ng v·∫≠t d·ª•ng h·ª£p l√Ω, kh√¥ng c√≥ th·ª´a"
                }
            },
            4: {
                guide: "C√≥ quy t·∫Øc/h∆∞·ªõng d·∫´n s√†ng l·ªçc v·∫≠t d·ª•ng ƒë·ªãnh k·ª≥ (b·ªè nh·ªØng th·ª© kh√¥ng d√πng, kh√¥ng c·∫ßn)",
                suggestion: "üìå Ph·∫£i c√≥ vƒÉn b·∫£n/h∆∞·ªõng d·∫´n s√†ng l·ªçc v√† th·ª±c hi·ªán ƒë·ªãnh k·ª≥\n‚úÖ V√≠ d·ª•: M·ªói qu√Ω ki·ªÉm tra v√† lo·∫°i b·ªè v·∫≠t d·ª•ng kh√¥ng c√≤n s·ª≠ d·ª•ng",
                levels: {
                    1: "Kh√¥ng c√≥ quy ƒë·ªãnh s√†ng l·ªçc",
                    2: "C√≥ quy ƒë·ªãnh nh∆∞ng kh√¥ng th·ª±c hi·ªán",
                    3: "C√≥ th·ª±c hi·ªán nh∆∞ng kh√¥ng ƒë·ªãnh k·ª≥",
                    4: "C√≥ quy ƒë·ªãnh v√† th·ª±c hi·ªán g·∫ßn ƒë·ªãnh k·ª≥",
                    5: "C√≥ quy ƒë·ªãnh r√µ r√†ng v√† th·ª±c hi·ªán ƒë√∫ng ƒë·ªãnh k·ª≥"
                }
            },
            5: {
                guide: "VƒÉn ph√≤ng ph·∫©m, c√¥ng c·ª• lao ƒë·ªông, thu·ªëc, v·∫≠t t∆∞ y t·∫ø,‚Ä¶ ƒë∆∞·ª£c s·∫Øp x·∫øp m·ªôt c√°ch ngƒÉn n·∫Øp, khoa h·ªçc, th·∫©m m·ªπ",
                suggestion: "‚úÖ Ki·ªÉm tra c√°c k·ªá, t·ªß, b√†n l√†m vi·ªác\n‚úÖ V·∫≠t d·ª•ng ph·∫£i ƒë∆∞·ª£c ph√¢n lo·∫°i v√† s·∫Øp x·∫øp h·ª£p l√Ω",
                levels: {
                    1: "B·ª´a b·ªôn, kh√¥ng theo tr·∫≠t t·ª±",
                    2: "C√≥ s·∫Øp x·∫øp nh∆∞ng c√≤n l·ªôn x·ªôn nhi·ªÅu",
                    3: "S·∫Øp x·∫øp t∆∞∆°ng ƒë·ªëi nh∆∞ng ch∆∞a khoa h·ªçc",
                    4: "S·∫Øp x·∫øp t·ªët, ch·ªâ c√≤n v√†i ƒëi·ªÉm ch∆∞a ho√†n ch·ªânh",
                    5: "NgƒÉn n·∫Øp, khoa h·ªçc, th·∫©m m·ªπ, d·ªÖ t√¨m ki·∫øm"
                }
            },
            6: {
                guide: "M·ªçi th·ª© ƒë∆∞·ª£c c·∫•t, gi·ªØ t·∫°i m·ªôt n∆°i C·ªê ƒê·ªäNH v√† tr·∫£ v·ªÅ ƒë√∫ng v·ªã tr√≠ sau khi s·ª≠ d·ª•ng",
                suggestion: "üìå M·ªói v·∫≠t d·ª•ng c√≥ v·ªã tr√≠ ri√™ng, ƒë∆∞·ª£c ƒë√°nh d·∫•u/nh√£n\n‚úÖ H·ªèi nh√¢n vi√™n: Sau khi d√πng xong, c√≥ tr·∫£ v·ªÅ ƒë√∫ng ch·ªó kh√¥ng?",
                levels: {
                    1: "Kh√¥ng c√≥ v·ªã tr√≠ c·ªë ƒë·ªãnh, ƒë·ªÉ t√πy ti·ªán",
                    2: "C√≥ nh∆∞ng th∆∞·ªùng xuy√™n kh√¥ng tr·∫£ v·ªÅ ƒë√∫ng ch·ªó",
                    3: "ƒêa s·ªë c√≥ v·ªã tr√≠ nh∆∞ng th·ªânh tho·∫£ng sai",
                    4: "H·∫ßu h·∫øt ƒë√∫ng v·ªã tr√≠, c√≤n 1-2 ƒëi·ªÉm sai",
                    5: "T·∫•t c·∫£ ƒë·ªÅu c√≥ v·ªã tr√≠ c·ªë ƒë·ªãnh v√† tr·∫£ v·ªÅ ƒë√∫ng ch·ªó"
                }
            },
            7: {
                guide: "N∆°i c·∫•t gi·ªØ ƒë∆∞·ª£c thi·∫øt k·∫ø d·ªÖ d√†ng v√† thu·∫≠n ti·ªán khi s·ª≠ d·ª•ng",
                suggestion: "‚úÖ Ki·ªÉm tra: V·∫≠t d·ª•ng th∆∞·ªùng d√πng c√≥ d·ªÖ l·∫•y kh√¥ng?\n‚úÖ C√≥ c·∫ßn leo tr√®o, di chuy·ªÉn nhi·ªÅu ƒë·ªÉ l·∫•y ƒë·ªì kh√¥ng?",
                levels: {
                    1: "R·∫•t kh√≥ ti·∫øp c·∫≠n, thi·∫øt k·∫ø kh√¥ng h·ª£p l√Ω",
                    2: "Kh√≥ l·∫•y, m·∫•t nhi·ªÅu th·ªùi gian",
                    3: "T∆∞∆°ng ƒë·ªëi thu·∫≠n ti·ªán nh∆∞ng c√≥ th·ªÉ c·∫£i thi·ªán",
                    4: "Thu·∫≠n ti·ªán, ch·ªâ c√≤n 1-2 ƒëi·ªÉm c·∫ßn c·∫£i ti·∫øn",
                    5: "Thi·∫øt k·∫ø t·ªëi ∆∞u, r·∫•t thu·∫≠n ti·ªán khi s·ª≠ d·ª•ng"
                }
            },
            8: {
                guide: "T·ªß nhi·ªÅu ngƒÉn, gi√° k·ªá l∆∞u tr·ªØ v√† c√°c thi·∫øt b·ªã c√≥ GHI NH√ÉN R√ï R√ÄNG, d·ªÖ ƒë·ªçc",
                suggestion: "üìå Ki·ªÉm tra: T·ªß, k·ªá, ngƒÉn c√≥ d√°n nh√£n kh√¥ng?\n‚úÖ Nh√£n ph·∫£i r√µ r√†ng, d·ªÖ ƒë·ªçc, ƒë√∫ng n·ªôi dung b√™n trong",
                levels: {
                    1: "Kh√¥ng c√≥ nh√£n",
                    2: "R·∫•t √≠t nh√£n, kh√¥ng r√µ r√†ng",
                    3: "C√≥ nh√£n nh∆∞ng kh√¥ng ƒë·∫ßy ƒë·ªß ho·∫∑c kh√≥ ƒë·ªçc",
                    4: "ƒêa s·ªë c√≥ nh√£n r√µ r√†ng, c√≤n v√†i ch·ªó thi·∫øu",
                    5: "T·∫•t c·∫£ ƒë·ªÅu c√≥ nh√£n r√µ r√†ng, ƒë√∫ng n·ªôi dung"
                }
            },
            9: {
                guide: "C√°c v·ªã tr√≠ ch·ªâ ƒë·ªãnh ƒë√£ ƒë∆∞·ª£c ƒê√ÅNH D·∫§U/K·∫∫ L√äN ƒë·ªÉ d·ªÖ nh√¨n th·∫•y (xe lƒÉn, b√¨nh ch·ªØa ch√°y,...)",
                suggestion: "üìå V·ªã tr√≠ ƒë·ªÉ xe, thi·∫øt b·ªã l·ªõn ph·∫£i c√≥ ƒë√°nh d·∫•u tr√™n s√†n ho·∫∑c t∆∞·ªùng\n‚úÖ V√≠ d·ª•: K·∫ª √¥ cho xe lƒÉn, ƒë√°nh d·∫•u v·ªã tr√≠ b√¨nh ch·ªØa ch√°y",
                levels: {
                    1: "Kh√¥ng c√≥ ƒë√°nh d·∫•u v·ªã tr√≠ n√†o",
                    2: "R·∫•t √≠t v·ªã tr√≠ ƒë∆∞·ª£c ƒë√°nh d·∫•u",
                    3: "C√≥ ƒë√°nh d·∫•u nh∆∞ng kh√¥ng ƒë·∫ßy ƒë·ªß",
                    4: "ƒêa s·ªë v·ªã tr√≠ quan tr·ªçng ƒë∆∞·ª£c ƒë√°nh d·∫•u",
                    5: "T·∫•t c·∫£ v·ªã tr√≠ quan tr·ªçng ƒë·ªÅu ƒë∆∞·ª£c ƒë√°nh d·∫•u r√µ r√†ng, ƒë·ªãnh v·ªã tr·ª±c quan"
                }
            },
            10: {
                guide: "V√πng l√†m vi·ªác, c√°c v·∫≠t d·ª•ng ƒë·ªÅu s·∫°ch s·∫Ω, kh√¥ng b·ª•i b·∫©n",
                suggestion: "‚úÖ Ki·ªÉm tra b·ªÅ m·∫∑t b√†n, t·ªß, thi·∫øt b·ªã: c√≥ b·ª•i kh√¥ng?\n‚úÖ S√†n nh√†, g√≥c t∆∞·ªùng c√≥ s·∫°ch kh√¥ng?",
                levels: {
                    1: "R·∫•t b·∫©n, nhi·ªÅu b·ª•i v√† v·∫øt b·∫©n",
                    2: "B·∫©n nhi·ªÅu n∆°i",
                    3: "T∆∞∆°ng ƒë·ªëi s·∫°ch nh∆∞ng c√≤n b·ª•i/v·∫øt b·∫©n",
                    4: "S·∫°ch s·∫Ω, ch·ªâ c√≤n 1-2 ƒëi·ªÉm nh·ªè",
                    5: "Ho√†n to√†n s·∫°ch s·∫Ω, kh√¥ng b·ª•i b·∫©n"
                }
            },
            11: {
                guide: "C·ª≠a s·ªï, b·∫≠u c·ª≠a s·ªï, n·ªÅn nh√†, t∆∞·ªùng, b√≥ng ƒë√®n, qu·∫°t,‚Ä¶ ƒë·ªÅu s·∫°ch s·∫Ω",
                suggestion: "‚úÖ Ki·ªÉm tra c√°c v·ªã tr√≠ th∆∞·ªùng b·ªã b·ªè qu√™n: b·∫≠u c·ª≠a, qu·∫°t tr·∫ßn, ƒë√®n\n‚úÖ Ph·∫£i c√≥ l·ªãch v·ªá sinh ƒë·ªãnh k·ª≥ cho c√°c v·ªã tr√≠ n√†y",
                levels: {
                    1: "R·∫•t b·∫©n, kh√¥ng ƒë∆∞·ª£c v·ªá sinh",
                    2: "B·∫©n nhi·ªÅu n∆°i kh√≥ th·∫•y",
                    3: "T∆∞∆°ng ƒë·ªëi s·∫°ch nh∆∞ng c√≤n m·ªôt s·ªë v·ªã tr√≠ b·∫©n",
                    4: "S·∫°ch s·∫Ω, ch·ªâ c√≤n 1-2 v·ªã tr√≠ ch∆∞a ho√†n h·∫£o",
                    5: "T·∫•t c·∫£ ƒë·ªÅu s·∫°ch s·∫Ω, k·ªÉ c·∫£ v·ªã tr√≠ kh√≥ th·∫•y"
                }
            },
            12: {
                guide: "C√≥ n∆°i l∆∞u tr·ªØ c√°c v·∫≠t d·ª•ng √≠t/kh√¥ng s·ª≠ d·ª•ng, s·∫°ch s·∫Ω, c√≥ d√°n nh√£n",
                suggestion: "üìå V·∫≠t d·ª•ng √≠t d√πng ph·∫£i c√≥ kho ri√™ng, kh√¥ng ƒë·ªÉ l·∫´n v·ªõi ƒë·ªì th∆∞·ªùng d√πng\n‚úÖ Kho ph·∫£i s·∫°ch s·∫Ω, c√≥ nh√£n, d·ªÖ t√¨m khi c·∫ßn",
                levels: {
                    1: "Kh√¥ng c√≥ n∆°i l∆∞u tr·ªØ ri√™ng",
                    2: "C√≥ nh∆∞ng l·ªôn x·ªôn, kh√¥ng nh√£n",
                    3: "C√≥ n∆°i l∆∞u tr·ªØ nh∆∞ng ch∆∞a g·ªçn g√†ng",
                    4: "C√≥ n∆°i l∆∞u tr·ªØ t·ªët, c√≤n thi·∫øu m·ªôt s·ªë nh√£n",
                    5: "C√≥ n∆°i l∆∞u tr·ªØ ri√™ng, s·∫°ch s·∫Ω, c√≥ nh√£n ƒë·∫ßy ƒë·ªß"
                }
            },
            13: {
                guide: "V·ªá sinh k√®m ki·ªÉm tra hi·ªán tr·∫°ng c√°c v·∫≠t d·ª•ng (c√≥ b·∫±ng ch·ª©ng nh∆∞ checklist ki·ªÉm tra, s·ªï b√†n giao...)",
                suggestion: "üìå Khi v·ªá sinh ph·∫£i ki·ªÉm tra lu√¥n t√¨nh tr·∫°ng thi·∫øt b·ªã\n‚úÖ C√≥ s·ªï/checklist ghi nh·∫≠n k·∫øt qu·∫£ ki·ªÉm tra",
                levels: {
                    1: "Kh√¥ng ki·ªÉm tra khi v·ªá sinh",
                    2: "C√≥ ki·ªÉm tra nh∆∞ng kh√¥ng ghi ch√©p",
                    3: "C√≥ ghi ch√©p nh∆∞ng kh√¥ng ƒë·∫ßy ƒë·ªß/ƒë·ªãnh k·ª≥",
                    4: "C√≥ checklist, th·ª±c hi·ªán t∆∞∆°ng ƒë·ªëi ƒë·ªÅu",
                    5: "C√≥ checklist ƒë·∫ßy ƒë·ªß, th·ª±c hi·ªán v√† ghi ch√©p ƒë·ªãnh k·ª≥"
                }
            },
            14: {
                guide: "Kh√¥ng ƒë·ªÉ c√°c v·∫≠t d·ª•ng b·ª´a b√£i (d√¢y ƒëi·ªán, d√¢y m·∫°ng, d√¢y oxy th·ªü ƒë∆∞·ª£c b·ªë tr√≠ g·ªçn g√†ng)",
                suggestion: "‚úÖ Ki·ªÉm tra d√¢y ƒëi·ªán, d√¢y m·∫°ng: c√≥ ƒë∆∞·ª£c b√≥ g·ªçn kh√¥ng?\n‚úÖ Kh√¥ng c√≥ d√¢y r·ªëi, ch·∫±ng ch·ªãt g√¢y m·∫•t an to√†n",
                levels: {
                    1: "R·∫•t b·ª´a b√£i, d√¢y r·ªëi nhi·ªÅu n∆°i",
                    2: "Nhi·ªÅu d√¢y ch∆∞a ƒë∆∞·ª£c gom g·ªçn",
                    3: "T∆∞∆°ng ƒë·ªëi g·ªçn nh∆∞ng c√≤n v√†i ch·ªó r·ªëi",
                    4: "G·ªçn g√†ng, ch·ªâ c√≤n 1-2 ƒëi·ªÉm c·∫ßn c·∫£i thi·ªán",
                    5: "T·∫•t c·∫£ d√¢y ƒëi·ªán, d√¢y m·∫°ng ƒë·ªÅu ƒë∆∞·ª£c b·ªë tr√≠ g·ªçn g√†ng, an to√†n"
                }
            },
            15: {
                guide: "Lu√¥n c·∫£i ti·∫øn v√† s·∫Øp x·∫øp ngƒÉn n·∫Øp (C√ì H√åNH ·∫¢NH TR∆Ø·ªöC SAU ƒë·ªÉ ch·ª©ng minh c·∫£i ti·∫øn)",
                suggestion: "üìå Ph·∫£i c√≥ ·∫£nh TR∆Ø·ªöC-SAU ƒë·ªÉ minh ch·ª©ng c·∫£i ti·∫øn\n‚úÖ V√≠ d·ª•: Thay ƒë·ªïi v·ªã tr√≠ xe ti√™m g·∫ßn gi∆∞·ªùng b·ªánh h∆°n ‚Üí gi·∫£m thao t√°c khi c·∫•p c·ª©u",
                levels: {
                    1: "Kh√¥ng c√≥ c·∫£i ti·∫øn n√†o trong nƒÉm",
                    2: "C√≥ 1 c·∫£i ti·∫øn nh·ªè, kh√¥ng c√≥ ·∫£nh tr∆∞·ªõc‚Äìsau",
                    3: "C√≥ √≠t nh·∫•t 1 c·∫£i ti·∫øn r√µ r√†ng (·∫£nh ho·∫∑c m√¥ t·∫£)",
                    4: "C√≥ √≠t nh·∫•t 1 c·∫£i ti·∫øn r√µ r√†ng (·∫£nh tr∆∞·ªõc‚Äìsau)",
                    5: "C√≥ ‚â•2 c·∫£i ti·∫øn c·ª• th·ªÉ, c√≥ vƒÉn b·∫£n/h·ªçp/b√°o c√°o, hi·ªáu qu·∫£ r√µ"
                }
            },
            16: {
                guide: "C√≥ l·ªãch ph√¢n c√¥ng tr·ª±c nh·∫≠t 5S t·∫°i khu v·ª±c ch·∫•m ƒëi·ªÉm",
                suggestion: "üìå Ph·∫£i c√≥ l·ªãch ph√¢n c√¥ng tr·ª±c 5S: h·ªç t√™n, th·ªùi gian, nhi·ªám v·ª•\n‚úÖ Ng∆∞·ªùi tr·ª±c ph·∫£i bi·∫øt nhi·ªám v·ª• v√† c√≥ k√Ω t√™n x√°c nh·∫≠n",
                levels: {
                    1: "Kh√¥ng c√≥ l·ªãch tr·ª±c ho·∫∑c l·ªãch c≈©, sai ng√†y",
                    2: "C√≥ l·ªãch nh∆∞ng kh√¥ng r√µ r√†ng (thi·∫øu h·ªç t√™n, ph√¢n c√¥ng)",
                    3: "C√≥ l·ªãch ƒë·∫ßy ƒë·ªß nh∆∞ng ng∆∞·ªùi tr·ª±c kh√¥ng bi·∫øt/kh√¥ng th·ª±c hi·ªán",
                    4: "C√≥ l·ªãch, ng∆∞·ªùi tr·ª±c bi·∫øt vi·ªác nh∆∞ng kh√¥ng c√≥ b·∫±ng ch·ª©ng th·ª±c hi·ªán",
                    5: "C√≥ l·ªãch r√µ, ng∆∞·ªùi tr·ª±c bi·∫øt, khu v·ª±c s·∫°ch, c√≥ b·∫±ng ch·ª©ng (k√Ω t√™n, ·∫£nh...)"
                }
            },
            17: {
                guide: "C√≥ ph·ªï bi·∫øn ‚Äì chia s·∫ª ph∆∞∆°ng ph√°p 5S cho t·∫•t c·∫£ nh√¢n vi√™n t·∫°i khoa (s·ªï h·ªçp/b·∫£ng ho·∫°t ƒë·ªông 5S)",
                suggestion: "üìå Nh√¢n vi√™n ph·∫£i bi·∫øt ‚Äì hi·ªÉu ‚Äì th·ª±c h√†nh 5S c∆° b·∫£n\n‚úÖ H·ªèi ng·∫´u nhi√™n 5 nh√¢n vi√™n v·ªÅ 5S: h·ªç c√≥ bi·∫øt kh√¥ng?",
                levels: {
                    1: "Kh√¥ng c√≥ h·ªçp/b·∫£n tin 5S, kh√¥ng ai bi·∫øt 5S l√† g√¨",
                    2: "C√≥ b·∫£ng th√¥ng tin 5S nh∆∞ng kh√¥ng ph·ªï bi·∫øn cho nh√¢n vi√™n",
                    3: "C√≥ h·ªçp/tri·ªÉn khai nh∆∞ng ‚â§2 nh√¢n vi√™n n·∫Øm ƒë√∫ng",
                    4: "C√≥ minh ch·ª©ng h·ªçp/tri·ªÉn khai, 1‚Äì2 ho·∫°t ƒë·ªông 5S gi√∫p gi·∫£m r·ªßi ro",
                    5: "C√≥ s·ªï h·ªçp/b·∫£ng tin, ‚â•5 nh√¢n vi√™n ƒë∆∞·ª£c h·ªèi ƒë·ªÅu tr·∫£ l·ªùi ƒë√∫ng"
                }
            },
            18: {
                guide: "C√≥ ƒë√°nh gi√° ƒë·ªãnh k·ª≥ (B·∫£ng ki·ªÉm 5S m·ªói th√°ng/khu v·ª±c) ƒë√∫ng th·ªùi h·∫°n",
                suggestion: "üìå G·ª≠i ƒëi·ªÉm 5S ƒë√∫ng h·∫°n (ng√†y 25 m·ªói th√°ng) k√®m ·∫£nh khu v·ª±c ch·∫•m\n‚úÖ C√≥ l∆∞u minh ch·ª©ng t·∫°i khoa/ph√≤ng",
                levels: {
                    1: "3 th√°ng/qu√Ω kh√¥ng g·ª≠i ƒëi·ªÉm hay ·∫£nh ch·∫•m",
                    2: "Ch·ªâ g·ª≠i ƒëi·ªÉm khi ƒë∆∞·ª£c nh·∫Øc, kh√¥ng c√≥ ·∫£nh minh ch·ª©ng",
                    3: "Tr·ªÖ h·∫°n v√† thi·∫øu ·∫£nh minh ch·ª©ng",
                    4: "ƒê√∫ng h·∫°n nh∆∞ng ·∫£nh minh ch·ª©ng tr·ªÖ/thi·∫øu",
                    5: "G·ª≠i ƒë√∫ng h·∫°n, ƒë·ªß ·∫£nh minh ch·ª©ng r√µ r√†ng t·ª´ng th√°ng"
                }
            },
            19: {
                guide: "V·∫≠t d·ª•ng ·ªü t√¨nh tr·∫°ng s·∫µn s√†ng s·ª≠ d·ª•ng (kh√¥ng h∆∞, h·∫øt h·∫°n, h·∫øt pin, kh√¥ng t√¨m th·∫•y...)",
                suggestion: "üìå T·∫•t c·∫£ d·ª•ng c·ª• ph·∫£i s·∫µn s√†ng: ƒë√∫ng v·∫≠t d·ª•ng, ƒë√∫ng t√¨nh tr·∫°ng, ƒë√∫ng th·ªùi ƒëi·ªÉm\n‚úÖ Ki·ªÉm tra ng·∫´u nhi√™n: pin c√≤n kh√¥ng? H·∫°n s·ª≠ d·ª•ng? C√≥ t√¨m th·∫•y kh√¥ng?",
                levels: {
                    1: "‚â•5 v·∫≠t d·ª•ng kh√¥ng s·∫µn s√†ng (h∆∞, h·∫øt h·∫°n, h·∫øt pin,...)",
                    2: "3‚Äì4 v·∫≠t d·ª•ng kh√¥ng s·∫µn s√†ng",
                    3: "2 v·∫≠t d·ª•ng kh√¥ng s·∫µn s√†ng",
                    4: "1 v·∫≠t d·ª•ng kh√¥ng s·∫µn s√†ng",
                    5: "T·∫•t c·∫£ v·∫≠t d·ª•ng s·∫µn s√†ng, ‚â•3 nh√¢n vi√™n bi·∫øt r√µ v·ªã tr√≠"
                }
            },
            20: {
                guide: "C√≥ ph√¢n t√≠ch nguy√™n nh√¢n ‚Äì c·∫£i ti·∫øn sau ƒë√°nh gi√° m·ªói th√°ng",
                suggestion: "üìå Sau ch·∫•m ƒëi·ªÉm ph·∫£i xem l·∫°i ƒëi·ªÉm ch∆∞a t·ªët, t√¨m nguy√™n nh√¢n, ƒë·ªÅ ra c√°ch kh·∫Øc ph·ª•c\n‚úÖ C√≥ chia s·∫ª ƒëi·ªÉm t·ªët ƒë·ªÉ nh√¢n r·ªông",
                levels: {
                    1: "Kh√¥ng c√≥ ho·∫°t ƒë·ªông ƒë√°nh gi√° ‚Äì ph√¢n t√≠ch ‚Äì c·∫£i ti·∫øn n√†o",
                    2: "C√≥ ƒë√°nh gi√° nh∆∞ng kh√¥ng li√™n t·ª•c, kh√¥ng n√™u nguy√™n nh√¢n",
                    3: "C√≥ ghi nh·∫≠n nguy√™n nh√¢n + h∆∞·ªõng kh·∫Øc ph·ª•c, kh√¥ng c√≥ minh ch·ª©ng",
                    4: "C√≥ ph√¢n t√≠ch nguy√™n nh√¢n + gi·∫£i ph√°p, ƒë√£ c·∫£i ti·∫øn √≠t nh·∫•t 1 ƒëi·ªÉm y·∫øu",
                    5: "C√≥ ƒë√°nh gi√° ƒë·ªãnh k·ª≥, c·∫£i ti·∫øn li√™n t·ª•c, chia s·∫ª c√¥ng khai m·ªói th√°ng"
                }
            }
        };

        // B·∫£ng ph√¢n lo·∫°i ƒëi·ªÉm
        const SCORE_CLASSIFICATION = [
            { min: 95, max: 100, label: "Xu·∫•t s·∫Øc", color: "#10b981", desc: "Th·ª±c hi·ªán to√†n di·ªán, kh√¥ng c√≥ l·ªói" },
            { min: 80, max: 94, label: "T·ªët", color: "#3b82f6", desc: "Duy tr√¨ t·ªët, c√≥ th·ªÉ c√≤n l·ªói nh·ªè" },
            { min: 70, max: 79, label: "Kh√°", color: "#f59e0b", desc: "C√≥ th·ª±c hi·ªán, c√≤n v√†i ƒëi·ªÉm ch∆∞a ƒë·∫ßy ƒë·ªß" },
            { min: 60, max: 69, label: "Trung b√¨nh", color: "#f97316", desc: "Ch∆∞a ·ªïn ƒë·ªãnh, c√≤n sai s√≥t r√µ r√†ng" },
            { min: 0, max: 59, label: "Ch∆∞a ƒë·∫°t", color: "#ef4444", desc: "Thi·∫øu ki·ªÉm so√°t, c·∫ßn c·∫£i ti·∫øn" }
        ];

        // Initial Data - Full data from Excel
        const INITIAL_DEPTS = {
            "KHOA_BA_CHUYEN_KHOA": {
                "name": "KHOA BA CHUY√äN KHOA",
                "zones": {
                    "PHONG_IEU_TRI_RANG": { "name": "Ph√≤ng ƒëi·ªÅu tr·ªã rƒÉng", "items": ["ph√≤ng ƒëi·ªÅu tr·ªã rƒÉng", "Xe ti√™m ph√≤ng ƒëi·ªÅu tr·ªã rƒÉng", "T·ªß d·ª•ng c·ª•"] },
                    "PHONG_HANH_CHANH_2": { "name": "Phong h√†nh ch√°nh 2", "items": ["phong hanh chanh 2"] },
                    "BAN_KHAM_RANG_HAM_MAT": { "name": "B√†n kh√°m rƒÉng h√†m m·∫∑t", "items": ["Khu kh√°m theo y√™u c·∫ßu"] },
                    "TU_DUNG_CU": { "name": "T·ªß d·ª•ng c·ª•", "items": ["Ph√≤ng ti·ªÉu ph·∫´u", "PH√íNG TI·ªÇU PH·∫™U"] },
                    "KE_HO_SO": { "name": "K·ªá h·ªì s∆°", "items": ["Ph√≤ng h√†nh ch√°nh"] },
                    "XE_TIEM_THUOC": { "name": "Xe ti√™m thu·ªëc", "items": ["Ph√≤ng b·ªánh n·∫∑ng"] },
                    "PHONG_NOI_SOI": { "name": "ph√≤ng n·ªôi soi", "items": ["ph√≤ng n·ªçi soi"] }
                }
            },
            "KHOA_CAP_CUU": {
                "name": "KHOA C·∫§P C·ª®U",
                "zones": {
                    "KHO": { "name": "KHO", "items": ["V·∫¨T T∆Ø Y T·∫æ", "PH√íNG TRANG THI·∫æT B·ªä"] },
                    "KV_BENH_NHAN": { "name": "KV b·ªÜNH NH√ÇN", "items": ["S·∫¢NH NH·∫¨N B·ªÜNH"] },
                    "TU_THUOC_TRUC": { "name": "T·ª¶ THU·ªêC TR·ª∞C", "items": ["PH√íNG L∆ØU B·ªÜNH"] },
                    "KHU_VUC_HANH_CHANH": { "name": "KHU V·ª∞C H√ÄNH CH√ÅNH", "items": ["QU·∫¶Y H√ÄNH CH√ÅNH", "Kho h·ªì s∆°", "KHO"] },
                    "KHU_VUC_NHAN_VIEN": { "name": "KHU V·ª∞C NH√ÇN VI√äN", "items": ["KV GIAO BAN", "PH√íNG ƒêI·ªÄU D∆Ø·ª†NG N·ªÆ"] },
                    "KHU_VUC_LOC_BENH": { "name": "khu v·ª±c l·ªçc b·ªánh", "items": ["qu·∫ßy nh·∫≠n b·ªánh"] }
                }
            },
            "KHOA_CHAN_OAN_HINH_ANH": {
                "name": "KHOA CH·∫®N ƒêO√ÅN H√åNH ·∫¢NH",
                "zones": {
                    "QUAY_SIEU_AM": { "name": "Qu·∫ßy si√™u √¢m", "items": ["Qu·∫ßy si√™u √¢m"] },
                    "QUAY_X_QUANG": { "name": "Qu·∫ßy x quang", "items": ["Qu·∫ßy x quang", "Qu·∫ßy X-quang"] },
                    "PHONG_3_SIEU_AM": { "name": "Ph√≤ng 3 si√™u √¢m", "items": ["Ph√≤ng 3 si√™u √¢m"] },
                    "PHONG_HANH_CHANH": { "name": "Ph√≤ng h√†nh ch√°nh", "items": ["Ph√≤ng h√†nh ch√°nh"] }
                }
            },
            "KHOA_CHAN_THUONG_CHINH_HINH": {
                "name": "KHOA CH·∫§N TH∆Ø∆†NG CH·ªàNH H√åNH",
                "zones": {
                    "PHONG_BENH_NANG_816": { "name": "Ph√≤ng b·ªánh n·∫∑ng 816", "items": ["Ph√≤ng b·ªánh"] },
                    "P_TIEP_NHAN_BENH": { "name": "P ti·∫øp nh·∫≠n b·ªánh", "items": ["Khu v·ª±c ph√≤ng b·ªánh"] },
                    "P_BO_BOT": { "name": "P b√≥ b·ªôt", "items": ["Khu nh√¢n vi√™n"] },
                    "P_THAY_BANG": { "name": "P thay bƒÉng", "items": ["Khu ph√≤ng b·ªánh"] },
                    "KV_NHAN_VIEN": { "name": "Kv nh√¢n vi√™n", "items": ["Kv nh√¢n vi√™n", "Ph√≤ng b√≥ b·ªôt", "Ph√≤ng ti√™m thu·ªëc"] }
                }
            },
            "KHOA_DINH_DUONG": {
                "name": "KHOA DINH D∆Ø·ª†NG",
                "zones": {
                    "QUAY_TIEP_NHAN": { "name": "QU·∫¶Y TI·∫æP NH·∫¨N", "items": ["T·ª¶ H·ªí S∆†", "kv ghi th√¥ng tin", "Khu v·ª±c nh·∫≠n b·ªánh"] },
                    "PHONG_CAN_O_THDD": { "name": "PH√íNG C√ÇN ƒêO & THDD", "items": ["B√ÄN TH·ª∞C H√ÄNH DINH D∆Ø·ª†NG"] },
                    "PHONG_KHAM_1": { "name": "PH√íNG KH√ÅM 1", "items": ["B√ÄN KH√ÅM B·ªÜNH", "B√†n kh√°m b·ªánh"] },
                    "PHONG_KHAM_2": { "name": "PH√íNG KH√ÅM 2", "items": ["B√ÄN KH√ÅM B·ªÜNH", "B√†n kh√°m b·ªánh"] },
                    "KV_HANH_CHANH": { "name": "KV H√ÄNH CH√ÅNH", "items": ["B√†n l√†m vi·ªác"] }
                }
            },
            "KHOA_DUOC_NHA_THUOC": {
                "name": "KHOA D∆Ø·ª¢C, NH√Ä THU·ªêC",
                "zones": {
                    "KHO_LE_NGOAI_TRU": { "name": "KHO L·∫∫ NGO·∫†I TR√ö", "items": ["KHO L·∫∫ NGO·∫†I TR√ö"] },
                    "KHO_LE_NOI_TRU": { "name": "KHO L·∫∫ N·ªòI TR√ö", "items": ["Kho l·∫ª n·ªôi tr√∫ (thu·ªëc)", "KHO VTYT"] },
                    "KHO_CHAN": { "name": "KHO CH·∫¥N", "items": ["KHO THU·ªêC", "Kho h√≥a ch·∫•t", "KHO VACCIN"] },
                    "BHYT": { "name": "BHYT", "items": ["T·ª¶ ƒê·ª∞NG THU·ªêC L·∫∫", "K·ªÜ ƒê·ª∞NG THU·ªêC CH·∫¥N", "PALLET ƒê·ªÇ THU·ªêC"] },
                    "THONG_KE": { "name": "TH·ªêNG K√ä", "items": ["T·ª¶ H·ªí S∆†", "B√†n l√†m vi·ªác"] }
                }
            },
            "KHOA_GAY_ME_HOI_SUC": {
                "name": "KHOA G√ÇY M√ä H·ªíI S·ª®C",
                "zones": {
                    "KHU_VUC_PHONG_MO": { "name": "Khu v·ª±c ph√≤ng m·ªï", "items": ["Ph√≤ng m·ªï 4", "Ph√≤ng m·ªï s·ªë 1", "Ph√≤ng m·ªï s·ªë 7", "Ph√≤ng soi ti√™u h√≥a"] },
                    "KHO": { "name": "Kho", "items": ["N∆°i l∆∞u v·∫≠t t∆∞ y t·∫ø ti√™u hao"] },
                    "KHU_VUC_NHAN_VIEN": { "name": "Khu v·ª±c nh√¢n vi√™n", "items": ["Ph√≤ng nh√¢n vi√™n n·ªØ", "Ph√≤ng th·ªß t·ª•c h√†nh ch√≠nh", "Ph√≤ng giao ban"] },
                    "KHU_VUC_BUONG_BENH": { "name": "Khu v·ª±c bu·ªìng b·ªánh", "items": ["Ph√≤ng ƒë·ª±ng t·ªß thu·ªëc, t·ªß d·ª•ng c·ª•, VTTH"] }
                }
            },
            "KHOA_HO_HAP": {
                "name": "KHOA H√î H·∫§P",
                "zones": {
                    "PHONG_O_CHUC_HO_HAP": { "name": "PH√íNG ƒêO CH·ª®C H√î H·∫§P", "items": ["PH√íNG ƒêO CH·ª®C H√î H·∫§P NƒÇNG"] },
                    "PHONG_GIAO_BAN": { "name": "PH√íNG GIAO BAN", "items": ["PH√íNG GIAO BAN"] },
                    "PHONG_HANH_CHANH": { "name": "PH√íNG H√ÄNH CH√ÅNH", "items": ["B√ÄN M√ÅY VI T√çNH"] },
                    "TIEM_TRUYEN_THUOC": { "name": "TI√äM TRUY·ªÄN THU·ªêC", "items": ["XE C·∫§P C·ª®U"] },
                    "KHU_VUC_TIEP_NHAN": { "name": "KHU V·ª∞C TI·∫æP NH·∫¨N", "items": ["T·ª¶ THU·ªêC TR·ª∞C", "XE TI√äM THU·ªêC"] }
                }
            },
            "KHOA_HOI_SUC_TICH_CUC": {
                "name": "KHOA H·ªíI S·ª®C T√çCH C·ª∞C CH·ªêNG ƒê·ªòC",
                "zones": {
                    "KV1": { "name": "Kv1", "items": ["Qu·∫ßy"] },
                    "KHU_VUC_2": { "name": "Khu V·ª±c 2", "items": ["Ph√≤ng Trang Thi·∫øt B·ªã 1"] },
                    "PHONG_BENH_1": { "name": "Ph√≤ng B·ªánh 1", "items": ["Kv3", "Khu V·ª±c 3"] },
                    "QUAY": { "name": "Qu·∫ßy", "items": ["Khu V·ª±c 1"] },
                    "PHONG_TU_THUOC": { "name": "Ph√≤ng T·ªß Thu·ªëc", "items": ["Khu V·ª±c 5"] },
                    "KHO_1": { "name": "Kho 1", "items": ["Khu V·ª±c 7"] }
                }
            },
            "KHOA_KHAM_BENH": {
                "name": "KHOA KH√ÅM B·ªÜNH",
                "zones": {
                    "KHU_VUC_KHAM": { "name": "Khu v·ª±c kh√°m", "items": ["Ph√≤ng c·∫•p c·ª©u", "B√†n nh·∫≠p vi·ªán", "Ph√≤ng kh√°m 04", "Ph√≤ng h√†nh ch√°nh", "Ph√≤ng kh√°m 07", "Ph√≤ng kh√°m 12"] }
                }
            },
            "KHOA_KHAM_CHUA_BENH_THEO_YEU_CAU": {
                "name": "KHOA KH√ÅM CH·ªÆA B·ªÜNH THEO Y√äU C·∫¶U",
                "zones": {
                    "P_TIEM_NGUA": { "name": "p. TI√äM NG·ª™A", "items": ["P.s∆° c·ª©u - nh·∫≠p vi·ªán", "PH√íNG KH√ÅM V√Ä T∆Ø V·∫§N"] },
                    "P_SO_CUU_NHAP_VIEN": { "name": "P. s∆° c·ª©u- nh·∫≠p vi·ªán", "items": ["P. s∆° c·ª©u- nh·∫≠p vi·ªán", "T·ªß d·ª•ng c·ª•"] },
                    "SANH_TIEP_NHAN": { "name": "S·∫¢NH TI·∫æP NH·∫¨N", "items": ["ph√≤ng ph√°t thu·ªëc chuy√™n gia", "Ph√≤ng kh√°m (p.chuy√™n gia)"] },
                    "P_HANH_CHANH_KHOA": { "name": "P.h√†nh ch√°nh khoa", "items": ["t·ªß nhi·ªÅu ngƒÉn"] }
                }
            },
            "KHOA_KIEM_SOAT_NHIEM_KHUAN": {
                "name": "KHOA KI·ªÇM SO√ÅT NHI·ªÑM KHU·∫®N",
                "zones": {
                    "KHU_VUC_DUNG_CU": { "name": "KHU V·ª∞C D·ª§NG C·ª§", "items": ["Ph√≤ng l∆∞u tr·ªØ d·ª•ng c·ª•", "Ph√≤ng r·ª≠a d·ª•ng c·ª•", "Qu·∫ßy tr·∫£ d·ª•ng c·ª•", "Ph√≤ng h·∫•p d·ª•ng c·ª•"] }
                }
            },
            "KHOA_NGOAI_TONG_HOP": {
                "name": "KHOA NGO·∫†I T·ªîNG H·ª¢P",
                "zones": {
                    "PHONG_THAY_BANG": { "name": "Ph√≤ng thay bƒÉng", "items": ["kV b·ªánh nh√¢n"] },
                    "PHONG_IEU_DUONG_TRUC": { "name": "Ph√≤ng ƒëi·ªÅu d∆∞·ª°ng tr·ª±c", "items": ["kV nh√¢n vi√™n"] },
                    "KV_KHO": { "name": "kV kho", "items": ["Kho l∆∞u tr·ªØ vƒÉn ph√≤ng ph·∫©m"] },
                    "KV_NHAN_VIEN": { "name": "kV nh√¢n vi√™n", "items": ["Ph√≤ng giao ban"] },
                    "KHU_VUC_BENH_NHAN": { "name": "Khu v·ª±c b·ªánh nh√¢n", "items": ["Ph√≤ng ti√™m thu·ªëc"] },
                    "PHONG_BENH_NANG_807": { "name": "Ph√≤ng b·ªánh n·∫∑ng (807)", "items": ["Kv b·ªánh nh√¢n"] }
                }
            },
            "KHOA_NOI_TIEU_HOA": {
                "name": "KHOA N·ªòI TI√äU H√ìA",
                "zones": {
                    "PHONG_TIEM_THUOC": { "name": "Ph√≤ng ti√™m thu·ªëc", "items": ["T·ªß thu·ªëc tr·ª±c", "Ph√≤ng ti√™m thu·ªëc"] },
                    "KHU_VUC_PHONG_HANH_CHINH": { "name": "Khu v·ª±c ph√≤ng h√†nh ch√≠nh", "items": ["Khu v·ª±c ph√≤ng h√†nh ch√≠nh"] },
                    "PHONG_KHAM_NOI_SOI": { "name": "Ph√≤ng kh√°m n·ªôi soi", "items": ["Ph√≤ng kh√°m ngo·∫°i tr√∫ n·ªôi ti√™u ho√°"] },
                    "QUAY_NHAN_BENH": { "name": "Qu·∫ßy nh·∫≠n b·ªánh", "items": ["Khu v·ª±c b·ªánh nh√¢n"] },
                    "KHU_VUC_RUA_DUNG_CU": { "name": "Khu v·ª±c r·ª≠a d·ª•ng c·ª•", "items": ["Khu v·ª±c r·ª≠a d·ª•ng c·ª• v√† b√†n giao KSNK"] }
                }
            },
            "KHOA_NOI_TIM_MACH": {
                "name": "KHOA N·ªòI TIM M·∫†CH",
                "zones": {
                    "P_TIEM_THUOC": { "name": "P. Ti√™m thu·ªëc", "items": ["P..ti√™m thu·ªëc"] },
                    "QUAY_NHAN_BENH": { "name": "Qu·∫ßy nh·∫≠n b·ªánh", "items": ["Qu·∫ßy nh·∫≠n b·ªánh"] },
                    "KHO": { "name": "Kho", "items": ["Kv kho", "kho", "Kho"] },
                    "TU_THUOC_PHONG_TIEM": { "name": "T·ªß thu·ªëc ph√≤ng ti√™m", "items": ["T·ªß thu·ªëc ph√≤ng ti√™m"] },
                    "HANH_CHANH": { "name": "H√†nh ch√°nh", "items": ["H√†nh ch√°nh"] }
                }
            },
            "KHOA_NOI_TONG_HOP": {
                "name": "KHOA N·ªòI T·ªîNG H·ª¢P",
                "zones": {
                    "KV_BENH": { "name": "KV B·ªÜNH", "items": ["PH√íNG S∆† C·ª®U", "PH√íNG TI√äM CH√çCH", "qu·∫ßy nh·∫≠n b·ªánh"] },
                    "KV_HANH_CHINH": { "name": "KV H√ÄNH CH√çNH", "items": ["K·ªÜ M√ÅY M√ìC THI·∫æT B·ªä", "T·ª¶ THU·ªêC", "PH√íNG GIAO BAN"] },
                    "KV_NOI_SOI": { "name": "kv n·ªôi soi", "items": ["ph√≤ng n·ªôi soi"] }
                }
            },
            "KHOA_SO_SINH": {
                "name": "KHOA S∆† SINH",
                "zones": {
                    "KHU_SO_SINH_NHE": { "name": "Khu s∆° sinh nh·∫π", "items": ["Ph√≤ng ti√™m thu·ªëc khu nh·∫π", "Ph√≤ng b·ªánh"] },
                    "KHU_SO_SINH_NANG": { "name": "Khu s∆° sinh n·∫∑ng", "items": ["H√†nh ch√≠nh s∆° sinh n·∫∑ng", "Ph√≤ng b·ªánh", "Ph√≤ng b·ªánh NICU1"] },
                    "PHONG_HANH_CHANH": { "name": "Ph√≤ng h√†nh ch√°nh", "items": ["K·ªá phi·∫øu th√¥ng tin"] }
                }
            },
            "KHOA_SOT_XUAT_HUYET": {
                "name": "KHOA S·ªêT XU·∫§T HUY·∫æT",
                "zones": {
                    "KHU_VUC_NHAN_VIEN": { "name": "Khu v·ª±c nh√¢n vi√™n", "items": ["Ph√≤ng b√°c sƒ© nam", "Ph√≤ng tr∆∞·ªüng khoa", "Ph√≤ng h√†nh ch√°nh", "Ph√≤ng b√°c sƒ© n·ªØ"] },
                    "KHU_VUC_BUONG_BENH": { "name": "Khu v·ª±c bu·ªìng b·ªánh", "items": ["Khu v·ª±c r·ª≠a d·ª•ng c·ª•", "Ph√≤ng ti√™m thu·ªëc", "Qu·∫ßy nh·∫≠n b·ªánh"] },
                    "KHU_VUC_BENH_NHAN": { "name": "Khu v·ª±c b·ªánh nh√¢n", "items": ["Ph√≤ng b·ªánh th∆∞·ªùng", "Ph√≤ng h·ªìi s·ª©c c·∫•p c·ª©u (931)"] }
                }
            },
            "KHOA_TRUYEN_NHIEM": {
                "name": "KHOA TRUY·ªÄN NHI·ªÑM",
                "zones": {
                    "PHONG_GIAO_BAN": { "name": "PH√íNG GIAO BAN", "items": ["PH√íNG GIAO BAN"] },
                    "BAN_LAY_MAU": { "name": "B√ÄN L·∫§Y M√ÅU", "items": ["B√ÄN L·∫§Y M√ÅU"] },
                    "PHONG_THUOC": { "name": "PH√íNG THU·ªêC", "items": ["T·ª¶ THU·ªêC"] },
                    "XE_TIEM_THUOC": { "name": "XE TI√äM THU·ªêC", "items": ["XE TI√äM THU·ªêC"] },
                    "KHU_NHAN_BENH": { "name": "KHU NH·∫¨N B·ªÜNH", "items": ["KHU NH√ÇN VI√äN L√ÄM VI·ªÜC", "B√ÄN NH·∫¨N B·ªÜNH M·ªöI"] },
                    "PHONG_TIEM_THUOC": { "name": "PH√íNG TI√äM THU·ªêC", "items": ["T·ª¶ THU·ªêC TR·ª∞C"] }
                }
            },
            "KHOA_VAT_LY_TRI_LIEU": {
                "name": "KHOA V·∫¨T L√ù TR·ªä LI·ªÜU",
                "zones": {
                    "QUAY_TIEP_NHAN": { "name": "qu·∫ßy ti·∫øp nh·∫≠n", "items": ["khu v·ª±c h√†nh ch√≠nh"] },
                    "PHONG_VAN_DONG": { "name": "Ph√≤ng V·∫≠n ƒê·ªông", "items": ["Khu v·ª±c kh√°m"] },
                    "PHONG_KHAM": { "name": "ph√≤ng kh√°m", "items": ["khu v·ª±c kh√°m"] },
                    "KHU_VUC_KHAM": { "name": "Khu v·ª±c kh√°m", "items": ["ph√≤ng t√¢m l√Ω h√†nh vi", "Ph√≤ng kh√°m", "Ph√≤ng h√¥ h·∫•p", "Ph√≤ng v·∫≠n ƒë·ªông", "Ph√≤ng ch·ªânh h√¨nh"] },
                    "KHU_VUC_SINH_HOAT_CHUNG": { "name": "Khu v·ª±c sinh ho·∫°t chung", "items": ["Ph√≤ng sinh ho·∫°t chung"] }
                }
            },
            "KHOA_XET_NGHIEM": {
                "name": "KHOA X√âT NGHI·ªÜM",
                "zones": {
                    "PHONG_HUYET_HOC": { "name": "Ph√≤ng huy·∫øt h·ªçc", "items": ["T·ªß ƒë√¥ng tr·ªØ m√°u", "Ph√°t m√°u"] },
                    "PHONG_GIAO_BAN": { "name": "Ph√≤ng giao ban", "items": ["V·ªã tr√≠ treo gi·∫•y khen", "B·∫£ng ph√¢n c√¥ng c√¥ng vi·ªác"] },
                    "PHONG_LAY_MAU": { "name": "Ph√≤ng l·∫•y m√°u", "items": ["B√†n l·∫•y m√°u"] },
                    "QUAY_TIEP_NHAN": { "name": "Qu·∫ßy ti·∫øp nh·∫≠n", "items": ["B√†n l·∫•y m√°u", "Khu v·ª±c l·∫•y m√°u"] },
                    "PHONG_SINH_HOA": { "name": "Ph√≤ng sinh ho√°", "items": ["T√°ch huy·∫øt thanh"] },
                    "PHONG_QUAN_LY_CHAT_LUONG": { "name": "Ph√≤ng qu·∫£n l√Ω ch·∫•t l∆∞·ª£ng", "items": ["T·ªß l∆∞u h·ªì s∆°"] }
                }
            },
            "PHONG_CHI_DAO_TUYEN": {
                "name": "PH√íNG CH·ªà ƒê·∫†O TUY·∫æN",
                "zones": {
                    "KV_LAM_VIEC_CA_NHAN": { "name": "KV L√†m vi·ªác c√° nh√¢n", "items": ["KV Thay ƒë·ªì, ngh·ªâ c·ªßa nh√¢n vi√™n"] },
                    "KV_CAC_KE": { "name": "KV C√°c k·ªá", "items": ["KV K·ªá h·ªì s∆°", "KV K·ªá d·ª•ng c·ª• H·ªôi th·∫£o", "K·ªá H·ªì S∆° ph√≤ng CƒêT"] },
                    "KV_PHONG_HUAN_LUYEN": { "name": "KV Ph√≤ng Hu·∫•n luy·ªán", "items": ["KV kho Ph√≤ng Hu·∫•n luy·ªán"] },
                    "KV_CAC_TU": { "name": "KV C√°c T·ªß", "items": ["KV t·ªß vƒÉn ph√≤ng ph·∫©m th∆∞·ªùng d√πng", "KV t·ªß d·ª•ng c·ª• √≠t d√πng"] },
                    "KV_CAC_BAN": { "name": "KV c√°c b√†n", "items": ["KV b√†n l√†m vi·ªác c√° nh√¢n", "KV b√†n l√†m vi·ªác chung"] }
                }
            },
            "PHONG_CONG_TAC_XA_HOI": {
                "name": "PH√íNG C√îNG T√ÅC X√É H·ªòI",
                "zones": {
                    "QUAY_THONG_TIN_TANG_2": { "name": "Qu·∫ßy th√¥ng tin t·∫ßng 2", "items": ["Qu·∫ßy th√¥ng tin", "Qu·∫ßy th√¥ng tin t·∫ßng 2"] },
                    "PHONG_CONG_TAC_XA_HOI": { "name": "PH√íNG C√îNG T√ÅC X√É H·ªòI", "items": ["PH√íNG C√îNG T√ÅC X√É H·ªòI", "B√†n l√†m vi·ªác c√° nh√¢n"] },
                    "QUAY_THONG_TIN_TANG_1": { "name": "Qu·∫ßy th√¥ng tin t·∫ßng 1", "items": ["Qu·∫ßy th√¥ng tin", "Qu·∫ßy th√¥ng tin t·∫ßng 1"] },
                    "PHONG_CONG_TAC_DOAN_THE": { "name": "Ph√≤ng C√¥ng t√°c ƒêo√†n th·ªÉ", "items": ["02 b√†n l√†m vi·ªác c√° nh√¢n"] }
                }
            },
            "PHONG_DIEU_DUONG": {
                "name": "PH√íNG ƒêI·ªÄU D∆Ø·ª†NG",
                "zones": {
                    "PHONG_TRUONG_PHONG": { "name": "Ph√≤ng tr∆∞·ªüng ph√≤ng", "items": ["B√†n ti·∫øp kh√°ch ph√≤ng tr∆∞·ªüng ph√≤ng", "T·ªß h·ªì s∆°"] },
                    "PHONG_NHAN_VIEN": { "name": "Ph√≤ng nh√¢n vi√™n", "items": ["K·ªá h·ªì s∆°", "B√†n l√†m vi·ªác nh√¢n vi√™n 2"] },
                    "PHONG_DIEU_DUONG": { "name": "Ph√≤ng ƒëi·ªÅu d∆∞·ª°ng", "items": ["k·ªá vƒÉn ph√≤ng ph·∫©m", "B√†n l√†m vi·ªác nh√¢n vi√™n 2", "K·ªÜ H·ªí S∆† PH√íNG ƒêI·ªÄU D∆Ø·ª†NG", "B√†n ti·∫øp kh√°ch"] },
                    "PHONG_GIAO_BAN": { "name": "Ph√≤ng Giao Ban", "items": ["Khu v·ª±c nh√¢n vi√™n"] }
                }
            },
            "PHONG_HANH_CHANH_QUAN_TRI": {
                "name": "PH√íNG H√ÄNH CH√ÅNH QU·∫¢N TR·ªä",
                "zones": {
                    "VAN_THU": { "name": "VƒÇN TH∆Ø", "items": ["B√ÄN L√ÄM VI·ªÜC", "vƒÉn th∆∞"] },
                    "CONG_XA": { "name": "C√îNG XA", "items": ["C√îNG XA", "PH√íNG TR·ª∞C"] },
                    "TO_VAN_THU": { "name": "T·ªï VƒÉn th∆∞", "items": ["b√†n l√†m vi·ªác"] },
                    "KHO_SUA_CHUA": { "name": "kho s·ª≠a ch·ªØa", "items": ["B√†n ƒë·ªÉ ƒë·ªì v√† tb s·ª≠a ch·ªØa"] },
                    "TO_CUNG_TIEU": { "name": "T·ªî CUNG TI√äU", "items": ["KHO CH·ª®A VPP"] },
                    "TO_KY_THUAT": { "name": "T·ªî K·ª∏ THU·∫¨T", "items": ["K·ªÜ ƒê·ª∞NG V·∫¨T T∆Ø"] }
                }
            },
            "PHONG_KE_HOACH_TONG_HOP": {
                "name": "PH√íNG K·∫æ HO·∫†CH T·ªîNG H·ª¢P",
                "zones": {
                    "PHONG_KHTH": { "name": "PH√íNG KHTH", "items": ["B√ÄN L√ÄM VI·ªÜC C·ª¶A LAN", "B√ÄN L√ÄM VI·ªÜC C·ª¶A BS TRUNG", "B√ÄN L√ÄM VI·ªÜC C·ª¶A LINH"] },
                    "KHO_HUY_HSBA": { "name": "KHO H·ª¶Y HSBA", "items": ["KHU V·ª∞C HSBA CH·ªú H·ª¶Y"] },
                    "TO_IT": { "name": "T·ªî IT", "items": ["B√ÄN L√ÄM VI·ªÜC C·ª¶A HI·∫æU"] },
                    "KHO_LUU_TRU_HSBA": { "name": "KHO L∆ØU TR·ªÆ HSBA", "items": ["B√ÄN L√ÄM VI·ªÜC C·ª¶A HUY"] },
                    "TO_TIN_HOC_IT": { "name": "T·ªî TIN H·ªåC (IT)", "items": ["B√ÄN L√ÄM VI·ªÜC C·ª¶A T√ÇN", "B√ÄN L√ÄM VI·ªÜC C·ª¶A QUANG", "B√ÄN L√ÄM VI·ªÜC C·ª¶A HU·ª≤NH"] }
                }
            },
            "PHONG_QUAN_LY_CHAT_LUONG": {
                "name": "PH√íNG QU·∫¢N L√ù CH·∫§T L∆Ø·ª¢NG",
                "zones": {
                    "PHONG_QLCL": { "name": "Ph√≤ng QLCL", "items": ["Nh√≥m B√†n l√†m vi·ªác c√° nh√¢n", "B√ÄN L√ÄM VI·ªÜC C√Å NH√ÇN", "Nh√≥m H·ªì s∆°", "Nh√≥m VPP"] },
                    "NHOM_BAN_LAM_VIEC_CA_NHAN": { "name": "NH√ìM B√ÄN L√ÄM VI·ªÜC C√Å NH√ÇN", "items": ["7 B√ÄN L√ÄM VI·ªÜC C√Å NH√ÇN TRONG PH√íNG", "T·ª™ B√ÄN S·ªê 1 ƒê·∫æN B√ÄN S·ªê 7"] },
                    "NHOM_HO_SO": { "name": "NH√ìM H·ªí S∆†", "items": ["T·ª¶ HS S·ªê 1, 2 V√Ä K·ªÜ HS NƒÇM C≈®"] },
                    "NHOM_VPP": { "name": "NH√ìM VPP", "items": ["K·ªÜ VPP V√Ä KHO VPP"] }
                }
            },
            "PHONG_TAI_CHINH_KE_TOAN": {
                "name": "PH√íNG T√ÄI CH√çNH K·∫æ TO√ÅN",
                "zones": {
                    "TO_VAN_PHONG": { "name": "T·ªî VƒÇN PH√íNG", "items": ["PH√íNG K·∫æ TO√ÅN 2", "PH√íNG BHYT", "PH√íNG K·∫æ TO√ÅN 1"] },
                    "KHO_HO_SO": { "name": "KHO H·ªí S∆†", "items": ["KHO H·ªí S∆†"] },
                    "TO_VIEN_PHI": { "name": "T·ªî VI·ªÜN PH√ç", "items": ["T·ªî VI·ªÜN PH√ç"] }
                }
            },
            "PHONG_TO_CHUC_CAN_BO": {
                "name": "PH√íNG T·ªî CH·ª®C C√ÅN B·ªò",
                "zones": {
                    "KHO": { "name": "kho", "items": ["h·ªì s∆° theo nh√≥m, k·ªá", "K·ªÜ H·ªí S∆† THEO NH√ìM", "T·ª¶ H·ªí S∆†", "L∆∞u tr·ªØ HS"] },
                    "KHO_HO_SO": { "name": "KHO H·ªí S∆†", "items": ["K·ªÜ H·ªí S∆† VI√äN CH·ª®C, K·ªÜ VƒÇN PH√íNG PH·∫®M"] },
                    "PHONG_TCCB": { "name": "PH√íNG TCCB", "items": ["T·ª¶ H·ªí S∆†", "B√ÄN L√ÄM VI·ªÜC PH√íNG TCCB", "b√†n ti·∫øp kh√°ch"] },
                    "PHONG_LIEN_HE_CONG_TAC": { "name": "PH√íNG LI√äN H·ªÜ C√îNG T√ÅC", "items": ["B√ÄN L√ÄM VI·ªÜC"] },
                    "PHONG_LHCT": { "name": "PH√íNG LHCT", "items": ["B√ÄN L√ÄM VI·ªÜC", "T·ªß/ k·ªá h·ªì s∆°"] }
                }
            },
            "PHONG_VAT_TU_THIET_BI_Y_TE": {
                "name": "PH√íNG V·∫¨T T∆Ø THI·∫æT B·ªä Y T·∫æ",
                "zones": {
                    "PHONG_LAM_VIEC": { "name": "Ph√≤ng l√†m vi·ªác", "items": ["B√†n l√†m vi·ªác chung", "B√ÄN L√ÄM VI·ªÜC CHUNG", "B√†n l√†m vi·ªác c√° nh√¢n"] },
                    "KHO_CHUA_TB": { "name": "Kho ch·ª©a TB", "items": ["K·ªá ch·ª©a thi·∫øt b·ªã s·ªë 1"] },
                    "KHO_SUA_CHUA": { "name": "Kho s·ª≠a ch·ªØa", "items": ["B√†n ƒë·ªÉ d·ª•ng c·ª• s·ª≠a ch·ªØa"] },
                    "KHO_OXY": { "name": "Kho oxy", "items": ["Khu v·ª±c oxy chai ƒë·∫ßy"] },
                    "KHO_CHUA_OXY_CHAI": { "name": "Kho ch·ª©a oxy chai", "items": ["Kho ch·ª©a oxy chai"] },
                    "KHO_CHUA_THIET_BI_MOI": { "name": "Kho ch·ª©a thi·∫øt b·ªã m·ªõi", "items": ["K·ªá 1"] }
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('scoreMonth').value = monthStr;
            document.getElementById('reportFrom').value = monthStr;
            document.getElementById('reportTo').value = monthStr;

            checkSession();
            initializeData();
            renderCriteriaTable();
        });

        async function initializeData() {
            const usersSnap = await db.ref('users_5s').once('value');
            if (!usersSnap.exists()) {
                await db.ref('users_5s/admin').set({ username: 'admin', password: 'admin123', fullname: 'Qu·∫£n tr·ªã vi√™n', role: 'admin', department: '' });
            }
            const deptsSnap = await db.ref('departments_5s').once('value');
            if (!deptsSnap.exists()) {
                await db.ref('departments_5s').set(INITIAL_DEPTS);
            }
        }

        function checkSession() {
            const session = localStorage.getItem('session_5s');
            if (session) {
                currentUser = JSON.parse(session);
                showMainApp();
            }
        }

        // Handle form submit for login (works better on iOS)
        function handleLoginSubmit(e) {
            e.preventDefault();
            // Blur inputs to close keyboard on iOS
            document.activeElement.blur();
            login();
        }

        async function login() {
            const username = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('loginPass').value;
            if (!username || !password) { showAlert('loginAlert', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error'); return; }

            const snap = await db.ref('users_5s/' + username).once('value');
            if (snap.exists() && snap.val().password === password) {
                currentUser = { ...snap.val(), id: username };
                localStorage.setItem('session_5s', JSON.stringify(currentUser));
                showMainApp();
            } else {
                showAlert('loginAlert', 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('session_5s');
            currentUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        }

        function showMainApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userInfo').innerHTML = `üë§ ${currentUser.fullname} <span class="badge ${currentUser.role === 'admin' ? 'badge-admin' : 'badge-user'}">${currentUser.role === 'admin' ? 'Admin' : 'User'}</span>`;

            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }

            loadDepartments();
            loadStats();
            loadRecentScores();
            loadChartDeptFilter();
            loadDeptStats();
            renderMonthlyChart();
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');

            if (tab === 'zones') loadZonesList();
            if (tab === 'users') loadUsersList();
            if (tab === 'report') loadDepartments();
        }

        async function loadDepartments() {
            const snap = await db.ref('departments_5s').once('value');
            const depts = snap.val() || {};

            ['scoreDept', 'reportDept', 'newDept'].forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;

                // Preserve the first placeholder option
                const firstOptionText = id === 'newDept' ? '' : (id === 'reportDept' ? '-- T·∫•t c·∫£ --' : '-- Ch·ªçn khoa/ph√≤ng --');
                sel.innerHTML = `<option value="">${firstOptionText}</option>`;

                Object.entries(depts).forEach(([k, v]) => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = v.name;
                    sel.appendChild(opt);
                });
            });
        }

        async function loadZones() {
            const deptId = document.getElementById('scoreDept').value;
            const sel = document.getElementById('scoreZone');
            sel.innerHTML = '<option value="">-- Ch·ªçn khu v·ª±c --</option>';
            document.getElementById('scoreItem').innerHTML = '<option value="">-- Ch·ªçn ƒë·∫°i di·ªán --</option>';

            if (!deptId) return;
            const snap = await db.ref('departments_5s/' + deptId + '/zones').once('value');
            const zones = snap.val() || {};
            Object.entries(zones).forEach(([k, v]) => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = v.name;
                sel.appendChild(opt);
            });
        }

        async function loadItems() {
            const deptId = document.getElementById('scoreDept').value;
            const zoneId = document.getElementById('scoreZone').value;
            const sel = document.getElementById('scoreItem');
            sel.innerHTML = '<option value="">-- Ch·ªçn ƒë·∫°i di·ªán --</option>';

            if (!deptId || !zoneId) return;
            const snap = await db.ref('departments_5s/' + deptId + '/zones/' + zoneId + '/items').once('value');
            const items = snap.val() || [];
            items.forEach((item, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = item;
                sel.appendChild(opt);
            });
        }

        function renderCriteriaTable() {
            let html = `<thead><tr><th style="width:50px">STT</th><th>Ti√™u ch√≠ ƒë√°nh gi√°</th><th style="width:200px">M·ª©c ƒëi·ªÉm (1-5)</th><th style="width:200px">L√Ω do</th></tr></thead><tbody>`;
            CRITERIA_5S.forEach(group => {
                html += `<tr class="s-group"><td colspan="4">${group.group}</td></tr>`;
                group.items.forEach(item => {
                    html += `<tr>
                <td>${item.id}</td>
                <td>${item.text} <button type="button" class="btn-guide" onclick="showGuide(${item.id})" title="Xem h∆∞·ªõng d·∫´n">üìñ</button></td>
                <td><div class="score-radio">${[1, 2, 3, 4, 5].map(n => `<label><input type="radio" name="score_${item.id}" value="${n}" onchange="calculateScore()"><span>${n}</span></label>`).join('')}</div></td>
                <td><input type="text" class="reason-input" id="reason_${item.id}" placeholder="L√Ω do..."></td>
            </tr>`;
                });
            });
            html += '</tbody>';
            document.getElementById('criteriaTable').innerHTML = html;
        }

        function showGuide(criteriaId) {
            const guide = CRITERIA_GUIDES[criteriaId];
            if (!guide) return;

            const criteriaText = (() => {
                for (const group of CRITERIA_5S) {
                    for (const item of group.items) {
                        if (item.id === criteriaId) return item.text;
                    }
                }
                return '';
            })();

            let levelsHtml = '<div class="guide-levels">';
            for (let i = 1; i <= 5; i++) {
                levelsHtml += `<div class="guide-level"><span class="level-score">${i}</span> ${guide.levels[i]}</div>`;
            }
            levelsHtml += '</div>';

            const modal = document.createElement('div');
            modal.className = 'guide-modal-overlay';
            modal.innerHTML = `
                <div class="guide-modal">
                    <div class="guide-modal-header">
                        <h3>üìñ H∆∞·ªõng d·∫´n Ti√™u ch√≠ ${criteriaId}</h3>
                        <button onclick="this.closest('.guide-modal-overlay').remove()">‚úï</button>
                    </div>
                    <div class="guide-modal-body">
                        <div class="guide-criteria-text"><strong>${criteriaText}</strong></div>
                        <div class="guide-section">
                            <h4>üìã H∆∞·ªõng d·∫´n ch·∫•m ƒëi·ªÉm</h4>
                            <p>${guide.guide}</p>
                        </div>
                        <div class="guide-section">
                            <h4>üí° G·ª£i √Ω th·ª±c hi·ªán</h4>
                            <p style="white-space:pre-line">${guide.suggestion}</p>
                        </div>
                        <div class="guide-section">
                            <h4>üìä C√°c m·ª©c ƒëi·ªÉm</h4>
                            ${levelsHtml}
                        </div>
                    </div>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        function calculateScore() {
            let total = 0;
            let answered = 0;
            for (let i = 1; i <= 20; i++) {
                const selected = document.querySelector(`input[name="score_${i}"]:checked`);
                if (selected) {
                    total += parseInt(selected.value);
                    answered++;
                }
            }

            const percentage = answered > 0 ? Math.round((total / (answered * 5)) * 100) : 0;
            const average = answered > 0 ? (total / answered).toFixed(2) : 0;

            // Find classification
            let classification = SCORE_CLASSIFICATION[SCORE_CLASSIFICATION.length - 1];
            for (const cls of SCORE_CLASSIFICATION) {
                if (percentage >= cls.min && percentage <= cls.max) {
                    classification = cls;
                    break;
                }
            }

            const resultHtml = `
                <div class="score-result">
                    <div class="score-result-item">
                        <span class="score-label">T·ªïng ƒëi·ªÉm:</span>
                        <span class="score-value">${total}/${answered * 5}</span>
                    </div>
                    <div class="score-result-item">
                        <span class="score-label">ƒêi·ªÉm TB:</span>
                        <span class="score-value">${average}/5</span>
                    </div>
                    <div class="score-result-item">
                        <span class="score-label">T·ª∑ l·ªá:</span>
                        <span class="score-value">${percentage}%</span>
                    </div>
                    <div class="score-result-item">
                        <span class="score-label">X·∫øp lo·∫°i:</span>
                        <span class="score-classification" style="background:${classification.color}">${classification.label}</span>
                    </div>
                    <div class="score-result-desc">${classification.desc}</div>
                </div>
            `;

            let resultDiv = document.getElementById('scoreResultSummary');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'scoreResultSummary';
                document.getElementById('criteriaTable').parentNode.appendChild(resultDiv);
            }
            resultDiv.innerHTML = answered > 0 ? resultHtml : '';
        }

        async function submitScore() {
            const deptId = document.getElementById('scoreDept').value;
            const zoneId = document.getElementById('scoreZone').value;
            const itemIdx = document.getElementById('scoreItem').value;
            const month = document.getElementById('scoreMonth').value;
            const evaluator = document.getElementById('scoreEvaluator').value.trim();
            const representative = document.getElementById('scoreRepresentative').value.trim();
            const imageFile = document.getElementById('scoreImageFile').files[0];

            if (!deptId || !zoneId || itemIdx === '' || !month || !evaluator) {
                showAlert('scoreAlert', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }

            const criteria = [];
            let total = 0, count = 0;
            CRITERIA_5S.forEach(group => {
                group.items.forEach(item => {
                    const radio = document.querySelector(`input[name="score_${item.id}"]:checked`);
                    const reason = document.getElementById(`reason_${item.id}`).value;
                    const score = radio ? parseInt(radio.value) : 0;
                    criteria.push({ id: item.id, score, reason });
                    total += score;
                    if (score > 0) count++;
                });
            });

            if (count < 20) {
                showAlert('scoreAlert', 'Vui l√≤ng ch·∫•m ƒëi·ªÉm t·∫•t c·∫£ 20 ti√™u ch√≠', 'error');
                return;
            }

            // Upload image to Cloudinary if selected
            let imageUrl = '';
            if (imageFile) {
                showAlert('scoreAlert', '‚è≥ ƒêang upload ·∫£nh...', 'success');
                imageUrl = await uploadToCloudinary(imageFile);
                if (!imageUrl) {
                    showAlert('scoreAlert', '‚ùå Upload ·∫£nh th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i', 'error');
                    return;
                }
            }

            const deptSnap = await db.ref('departments_5s/' + deptId).once('value');
            const zoneSnap = await db.ref('departments_5s/' + deptId + '/zones/' + zoneId).once('value');
            const itemsSnap = await db.ref('departments_5s/' + deptId + '/zones/' + zoneId + '/items').once('value');

            const scoreData = {
                department: deptSnap.val().name,
                departmentId: deptId,
                zone: zoneSnap.val().name,
                zoneId: zoneId,
                item: (itemsSnap.val() || [])[itemIdx],
                itemIdx: parseInt(itemIdx),
                month,
                evaluator,
                representative,
                imageUrl,
                criteria,
                total,
                average: (total / 20).toFixed(2),
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };

            await db.ref('scores_5s').push(scoreData);

            // Show inline success message
            const successMsg = document.getElementById('submitSuccessMsg');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            // Reset form
            document.querySelectorAll('.score-radio input').forEach(r => r.checked = false);
            document.querySelectorAll('.reason-input').forEach(r => r.value = '');
            clearImage();
            loadStats();
            loadRecentScores();
        }

        async function loadStats() {
            const deptsSnap = await db.ref('departments_5s').once('value');
            const scoresSnap = await db.ref('scores_5s').once('value');

            const depts = deptsSnap.val() || {};
            let zoneCount = 0;
            Object.values(depts).forEach(d => { zoneCount += Object.keys(d.zones || {}).length; });

            document.getElementById('statDepts').textContent = Object.keys(depts).length;
            document.getElementById('statZones').textContent = zoneCount;
            document.getElementById('statScores').textContent = Object.keys(scoresSnap.val() || {}).length;
        }

        async function loadRecentScores() {
            const snap = await db.ref('scores_5s').orderByChild('createdAt').limitToLast(5).once('value');
            const scores = [];
            snap.forEach(s => { scores.unshift({ id: s.key, ...s.val() }); });

            if (scores.length === 0) {
                document.getElementById('recentScores').innerHTML = '<p class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
                return;
            }

            let html = '<table><thead><tr><th>Ng√†y</th><th>Khoa/Ph√≤ng</th><th>Khu v·ª±c</th><th>ƒêi·ªÉm TB</th></tr></thead><tbody>';
            scores.forEach(s => {
                html += `<tr><td>${new Date(s.createdAt).toLocaleDateString('vi-VN')}</td><td>${s.department}</td><td>${s.zone}</td><td><strong>${s.average}</strong>/5</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('recentScores').innerHTML = html;
        }

        let monthlyChartInstance = null;

        async function loadChartDeptFilter() {
            const deptsSnap = await db.ref('departments_5s').once('value');
            const depts = deptsSnap.val() || {};
            const sel = document.getElementById('chartDeptFilter');
            sel.innerHTML = '<option value="">-- T·∫•t c·∫£ khoa/ph√≤ng --</option>';
            Object.entries(depts).sort((a, b) => a[1].name.localeCompare(b[1].name)).forEach(([k, v]) => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = v.name;
                sel.appendChild(opt);
            });
        }

        function filterDashboard() {
            const deptFilter = document.getElementById('chartDeptFilter').value;
            loadDeptStats(deptFilter);
            renderMonthlyChart(deptFilter);
        }

        async function loadDeptStats(deptFilter = '') {
            const scoresSnap = await db.ref('scores_5s').once('value');
            let allScores = [];
            scoresSnap.forEach(s => { allScores.push(s.val()); });

            // Apply filter if specified
            if (deptFilter) {
                allScores = allScores.filter(s => s.department === deptFilter);
            }

            if (allScores.length === 0) {
                document.getElementById('deptStatsContainer').innerHTML = '<p class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm</p>';
                return;
            }

            // Group by department
            const deptMap = {};
            allScores.forEach(s => {
                const deptName = s.department || 'Kh√¥ng x√°c ƒë·ªãnh';
                if (!deptMap[deptName]) {
                    deptMap[deptName] = { count: 0, totalAvg: 0, latestDate: null };
                }
                deptMap[deptName].count++;
                deptMap[deptName].totalAvg += parseFloat(s.average) || 0;
                const scoreDate = new Date(s.createdAt);
                if (!deptMap[deptName].latestDate || scoreDate > deptMap[deptName].latestDate) {
                    deptMap[deptName].latestDate = scoreDate;
                }
            });

            // Build table
            let html = '<table><thead><tr><th>Khoa/Ph√≤ng</th><th>S·ªë l∆∞·ª£t ch·∫•m</th><th>ƒêi·ªÉm TB</th><th>Ch·∫•m ƒëi·ªÉm g·∫ßn nh·∫•t</th></tr></thead><tbody>';
            const sortedDepts = Object.entries(deptMap).sort((a, b) => b[1].count - a[1].count);
            sortedDepts.forEach(([name, data]) => {
                const avg = (data.totalAvg / data.count).toFixed(2);
                const avgClass = avg >= 4 ? 'color:#10b981;' : avg >= 3 ? 'color:#f59e0b;' : 'color:#ef4444;';
                const dateStr = data.latestDate ? data.latestDate.toLocaleDateString('vi-VN') : '-';
                html += `<tr><td>${name}</td><td>${data.count}</td><td style="${avgClass}font-weight:600;">${avg}</td><td>${dateStr}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('deptStatsContainer').innerHTML = html;
        }

        async function renderMonthlyChart(deptFilter = '') {
            const scoresSnap = await db.ref('scores_5s').once('value');
            let allScores = [];
            scoresSnap.forEach(s => { allScores.push(s.val()); });

            // Apply filter if specified
            if (deptFilter) {
                allScores = allScores.filter(s => s.department === deptFilter);
            }

            if (allScores.length === 0) {
                if (monthlyChartInstance) monthlyChartInstance.destroy();
                return;
            }

            // Group by month
            const monthMap = {};
            allScores.forEach(s => {
                const month = s.month || 'N/A';
                if (!monthMap[month]) {
                    monthMap[month] = { total: 0, count: 0 };
                }
                monthMap[month].total += parseFloat(s.average) || 0;
                monthMap[month].count++;
            });

            // Sort months and prepare data
            const sortedMonths = Object.keys(monthMap).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return `T${parseInt(month)}/${year}`;
            });
            const data = sortedMonths.map(m => (monthMap[m].total / monthMap[m].count).toFixed(2));

            // Destroy old chart if exists
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ƒêi·ªÉm trung b√¨nh',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 5,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadReport() {
            const deptId = document.getElementById('reportDept').value;
            const deptName = document.getElementById('reportDept').selectedOptions[0]?.text || '';
            const from = document.getElementById('reportFrom').value;
            const to = document.getElementById('reportTo').value;

            const snap = await db.ref('scores_5s').once('value');
            let scores = [];
            snap.forEach(s => { scores.push({ id: s.key, ...s.val() }); });

            // Filter by department - check departmentId OR normalize department name comparison
            if (deptId) {
                scores = scores.filter(s => {
                    if (s.departmentId === deptId) return true;
                    // Normalize and compare names (remove extra spaces, compare case-insensitive)
                    const normalizedDeptName = deptName.trim().toUpperCase();
                    const normalizedScoreDept = (s.department || '').trim().toUpperCase();
                    return normalizedScoreDept === normalizedDeptName || normalizedScoreDept.includes(normalizedDeptName) || normalizedDeptName.includes(normalizedScoreDept);
                });
            }
            if (from) scores = scores.filter(s => s.month >= from);
            if (to) scores = scores.filter(s => s.month <= to);

            scores.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

            if (scores.length === 0) {
                document.getElementById('reportResult').innerHTML = '<p class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</p>';
                return;
            }

            const isAdmin = currentUser && currentUser.role === 'admin';
            let html = '<table><thead><tr><th>Th√°ng</th><th>Khoa/Ph√≤ng</th><th>Khu v·ª±c</th><th>ƒê·∫°i di·ªán</th><th>Ng∆∞·ªùi ƒë√°nh gi√°</th><th>ƒêi·ªÉm TB</th><th>·∫¢nh</th><th>Ng√†y t·∫°o</th>' + (isAdmin ? '<th>X√≥a</th>' : '') + '</tr></thead><tbody>';
            scores.forEach(s => {
                const imgHtml = s.imageUrl
                    ? `<a href="${s.imageUrl}" target="_blank"><img src="${s.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;cursor:pointer;"></a>`
                    : '<span style="color:var(--gray-600);">-</span>';
                const deleteBtn = isAdmin
                    ? `<button onclick="deleteScore('${s.id}')" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">üóëÔ∏è</button>`
                    : '';
                html += `<tr><td>${s.month}</td><td>${s.department}</td><td>${s.zone}</td><td>${s.item}</td><td>${s.evaluator}</td><td><strong>${s.average}</strong></td><td>${imgHtml}</td><td>${new Date(s.createdAt).toLocaleDateString('vi-VN')}</td>${isAdmin ? '<td>' + deleteBtn + '</td>' : ''}</tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('reportResult').innerHTML = html;
        }

        async function deleteScore(scoreId) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a b√°o c√°o!');
                return;
            }
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£n ghi n√†y?')) return;
            try {
                await db.ref('scores_5s/' + scoreId).remove();
                alert('ƒê√£ x√≥a th√†nh c√¥ng!');
                loadReport();
                loadRecentScores();
                loadStats();
            } catch (err) {
                alert('L·ªói khi x√≥a: ' + err.message);
            }
        }

        async function exportExcel() {
            const deptId = document.getElementById('reportDept').value;
            const from = document.getElementById('reportFrom').value;
            const to = document.getElementById('reportTo').value;

            const snap = await db.ref('scores_5s').once('value');
            let scores = [];
            snap.forEach(s => { scores.push({ id: s.key, ...s.val() }); });

            if (deptId) scores = scores.filter(s => s.departmentId === deptId);
            if (from) scores = scores.filter(s => s.month >= from);
            if (to) scores = scores.filter(s => s.month <= to);

            if (scores.length === 0) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }

            const data = [['Th√°ng', 'Khoa/Ph√≤ng', 'Khu v·ª±c', 'ƒê·∫°i di·ªán', 'Ng∆∞·ªùi ƒë√°nh gi√°', 'ƒê·∫°i di·ªán n∆°i ƒêG', 'T·ªïng ƒëi·ªÉm', 'ƒêi·ªÉm TB', 'Ng√†y t·∫°o']];
            scores.forEach(s => {
                data.push([s.month, s.department, s.zone, s.item, s.evaluator, s.representative, s.total, s.average, new Date(s.createdAt).toLocaleDateString('vi-VN')]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'B√°o c√°o 5S');
            XLSX.writeFile(wb, `Bao_cao_5S_${from || 'all'}_${to || 'all'}.xlsx`);
        }

        async function loadZonesList() {
            const snap = await db.ref('departments_5s').once('value');
            const depts = snap.val() || {};

            let html = '';
            Object.entries(depts).forEach(([deptId, dept]) => {
                html += `<div style="border:1px solid var(--gray-200);border-radius:12px;padding:16px;margin-bottom:16px;">
            <div class="flex flex-between"><h3>${dept.name}</h3>
            <div><button class="btn btn-primary btn-sm" onclick="showAddZoneModal('${deptId}')">‚ûï Th√™m khu v·ª±c</button>
            <button class="btn btn-danger btn-sm" onclick="deleteDept('${deptId}')">üóëÔ∏è</button></div></div>`;

                const zones = dept.zones || {};
                if (Object.keys(zones).length > 0) {
                    html += '<div style="margin-top:12px;">';
                    Object.entries(zones).forEach(([zoneId, zone]) => {
                        html += `<div style="background:var(--gray-50);padding:12px;border-radius:8px;margin-top:8px;">
                    <div class="flex flex-between"><strong>${zone.name}</strong>
                    <button class="btn btn-danger btn-sm" onclick="deleteZone('${deptId}','${zoneId}')">üóëÔ∏è</button></div>
                    <p style="font-size:0.85rem;color:var(--gray-600);margin-top:4px;">ƒê·∫°i di·ªán: ${(zone.items || []).join(', ')}</p>
                </div>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            });

            document.getElementById('zonesList').innerHTML = html || '<p class="text-center">Ch∆∞a c√≥ khoa/ph√≤ng n√†o</p>';
        }

        async function loadUsersList() {
            const snap = await db.ref('users_5s').once('value');
            const users = snap.val() || {};

            let html = '';
            Object.entries(users).forEach(([id, u]) => {
                html += `<tr><td>${u.username}</td><td>${u.fullname}</td><td>${u.department || '-'}</td>
            <td><span class="badge ${u.role === 'admin' ? 'badge-admin' : 'badge-user'}">${u.role}</span></td>
            <td>${id !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${id}')">üóëÔ∏è</button>` : ''}</td></tr>`;
            });
            document.getElementById('usersList').innerHTML = html;
        }

        function showAddUserModal() { loadDepartments(); document.getElementById('addUserModal').classList.add('show'); }
        function showAddDeptModal() { document.getElementById('addDeptModal').classList.add('show'); }
        function showAddZoneModal(deptId) { document.getElementById('zoneDeptId').value = deptId; document.getElementById('addZoneModal').classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const fullname = document.getElementById('newFullname').value.trim();
            const dept = document.getElementById('newDept').value;
            const role = document.getElementById('newRole').value;

            if (!username || !password || !fullname) { alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin'); return; }

            await db.ref('users_5s/' + username).set({ username, password, fullname, department: dept, role });
            closeModal('addUserModal');
            loadUsersList();
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newFullname').value = '';
        }

        async function deleteUser(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y?')) return;
            await db.ref('users_5s/' + id).remove();
            loadUsersList();
        }

        async function addDepartment() {
            const name = document.getElementById('newDeptName').value.trim();
            if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n khoa/ph√≤ng'); return; }
            const id = name.replace(/\s+/g, '_').toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            await db.ref('departments_5s/' + id).set({ name, zones: {} });
            closeModal('addDeptModal');
            loadDepartments();
            loadZonesList();
            loadStats();
            document.getElementById('newDeptName').value = '';
        }

        async function deleteDept(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a khoa/ph√≤ng n√†y v√† t·∫•t c·∫£ khu v·ª±c con?')) return;
            await db.ref('departments_5s/' + id).remove();
            loadDepartments();
            loadZonesList();
            loadStats();
        }

        async function addZone() {
            const deptId = document.getElementById('zoneDeptId').value;
            const name = document.getElementById('newZoneName').value.trim();
            const itemsText = document.getElementById('newZoneItems').value.trim();
            if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n khu v·ª±c'); return; }

            const items = itemsText.split('\n').map(i => i.trim()).filter(i => i);
            const id = name.replace(/\s+/g, '_').toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            await db.ref('departments_5s/' + deptId + '/zones/' + id).set({ name, items });
            closeModal('addZoneModal');
            loadZonesList();
            loadStats();
            document.getElementById('newZoneName').value = '';
            document.getElementById('newZoneItems').value = '';
        }

        async function deleteZone(deptId, zoneId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a khu v·ª±c n√†y?')) return;
            await db.ref('departments_5s/' + deptId + '/zones/' + zoneId).remove();
            loadZonesList();
            loadStats();
        }

        function showAlert(id, msg, type) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }
    </script>
</body>

</html>